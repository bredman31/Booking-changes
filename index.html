<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Cherry Tree Centre - Room Booking Calendar</title>
  <style>
    body {
      display: flex;
      margin: 0;
      font-family: Arial, sans-serif;
      height: 100vh;
      flex-direction: column;
    }
    .header {
      background: #f8f9fa;
      padding: 10px 20px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .view-selector {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .view-btn {
      padding: 8px 16px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      border-radius: 4px;
    }
    .view-btn.active {
      background: #007bff;
      color: white;
    }
    .counsellor-filter {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .form-container {
      width: 400px;
      padding: 10px;
      border-right: 1px solid #ccc;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .calendar-container {
      flex: 1;
      overflow: auto;
      padding: 10px;
      max-height: calc(100vh - 80px);
    }
    .controls {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .calendar-grid {
      display: grid;
      border: 1px solid #ccc;
      font-size: 0.85em;
      max-width: 100%;
      min-height: 400px;
    }
    .calendar-grid.day-view {
      grid-template-columns: 60px repeat(6, 1fr);
      grid-auto-rows: 35px;
    }
    .calendar-grid.week-view {
      grid-template-columns: 80px repeat(7, 1fr);
      grid-auto-rows: 30px;
    }
    .grid-header {
      background: #f0f0f0;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ccc;
      padding: 2px;
      font-size: 0.9em;
    }
    .time-header {
      background: #f8f8f8;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ccc;
      font-size: 0.8em;
    }
    .grid-cell {
      border: 1px solid #eee;
      padding: 2px;
      font-size: 0.75em;
      position: relative;
      overflow: hidden;
      background: #fff;
      line-height: 1.2;
      cursor: pointer;
    }
    .grid-cell.booked {
      border: 1px solid #333;
    }
    .grid-cell.booked.room-1 {
      background: #d4a5a5;
      border-color: #b89090;
    }
    .grid-cell.booked.room-2 {
      background: #b299d4;
      border-color: #9680c0;
    }
    .grid-cell.booked.room-4 {
      background: #a5d4a5;
      border-color: #90b890;
    }
    .grid-cell.booked.room-6 {
      background: #c8a882;
      border-color: #b5946e;
    }
    .grid-cell.booked.room-7 {
      background: #e6d45a;
      border-color: #d4c347;
    }
    .grid-cell.booked.online {
      background: #7dd87d;
      border-color: #6bc46b;
    }
    .grid-cell.past-booking {
      opacity: 0.5;
      cursor: not-allowed;
      background-color: #f5f5f5 !important;
      color: #999;
    }
    .grid-cell.selected-booking {
      box-shadow: 0 0 0 3px #ff6b6b inset, 0 0 8px rgba(255, 107, 107, 0.6);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 3px #ff6b6b inset, 0 0 8px rgba(255, 107, 107, 0.6); }
      50% { box-shadow: 0 0 0 3px #ff9999 inset, 0 0 12px rgba(255, 153, 153, 0.8); }
      100% { box-shadow: 0 0 0 3px #ff6b6b inset, 0 0 8px rgba(255, 107, 107, 0.6); }
    }
    .booking-info {
      font-weight: bold;
      color: #1976d2;
      font-size: 0.8em;
    }
    .client-name {
      color: #666;
      font-size: 0.7em;
    }
    .date-selector {
      font-weight: bold;
    }
    .week-navigation {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .counsellor-info {
      background: #e8f4f8;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
    }
    .hidden {
      display: none;
    }
    .past-booking-notice {
      background: #f8d7da;
      color: #721c24;
      padding: 8px;
      border-radius: 4px;
      margin-top: 10px;
      font-size: 12px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2 id="pageTitle">Cherry Tree Centre - Room Booking Calendar</h2>
    <div class="view-selector">
      <button class="view-btn active" onclick="switchView('day')">Day View</button>
      <button class="view-btn" onclick="switchView('week')">Week View</button>
    </div>
    <div class="counsellor-filter hidden" id="counsellorFilterContainer">
      <label>Counsellor:</label>
      <select id="counsellorSelect" onchange="filterByCounsellor()">
        <option value="">All Counsellors</option>
      </select>
    </div>
  </div>

  <div class="main-container">
    <div class="form-container">
      <div id="counsellorInfo" class="counsellor-info hidden">
        <h3 id="counsellorName"></h3>
        <p id="counsellorSummary"></p>
      </div>
      
      <!-- Custom booking change form -->
      <div style="background: #f9f9f9; padding: 20px; border-radius: 8px;">
        <h3>Modify Booking</h3>
        <p style="margin-bottom: 15px; font-size: 14px; color: #666;">Click on a booking in the calendar to modify it.</p>
        
        <form id="bookingChangeForm">
          <div style="margin-bottom: 15px;">
            <div style="font-size: 14px; line-height: 1.4;">
              <div style="margin-bottom: 8px;"><strong>Current Room:</strong> <span id="currentRoomDisplay"></span></div>
              <div style="margin-bottom: 8px;"><strong>Current Date:</strong> <span id="currentDateDisplay"></span></div>
              <div style="margin-bottom: 8px;"><strong>Current Time:</strong> <span id="currentTimeDisplay"></span></div>
            </div>
          </div>
          
          <!-- Hidden fields for form submission -->
          <input type="hidden" id="bookingCodeInput">
          <input type="hidden" id="currentRoomInput">
          <input type="hidden" id="currentDateInput">
          <input type="hidden" id="currentTimeInput">
          <input type="hidden" id="counsellorNameInput">
          
          <div id="pastBookingNotice" class="past-booking-notice hidden">
            This booking is within 24 hours and cannot be modified or cancelled online. Please contact the centre directly.
          </div>
          
          <div style="margin: 20px 0; text-align: center;">
            <button type="button" id="cancelBookingBtn" onclick="cancelBooking()" 
                    style="background: #dc3545; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; width: 100%; margin-bottom: 10px;"
                    disabled>
              Cancel This Appointment
            </button>
            <div id="cancelStatus" style="margin-top: 10px; padding: 8px; border-radius: 4px; display: none; font-size: 12px;"></div>
          </div>
          
          <hr style="margin: 20px 0; border: 1px solid #ddd;">
          <h4 style="margin-bottom: 15px; color: #007bff;">Or Request Changes:</h4>
          
          <div style="margin-bottom: 15px;">
            <label id="roomChangeLabel" style="display: block; font-weight: bold; margin-bottom: 5px;">New Room (if changing):</label>
            <select id="newRoomInput" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" disabled>
              <option value="">No change</option>
              <option value="Room 1">Room 1</option>
              <option value="Room 2">Room 2</option>
              <option value="Room 4">Room 4</option>
              <option value="Room 6">Room 6</option>
              <option value="Room 7">Room 7</option>
              <option value="Online">Online</option>
            </select>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">New Date (if changing):</label>
            <input type="date" id="newDateInput" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" disabled>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">New Time (if changing):</label>
            <select id="newTimeInput" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" disabled>
              <option value="">No change</option>
              <option value="08:00">08:00</option>
              <option value="09:00">09:00</option>
              <option value="10:00">10:00</option>
              <option value="11:00">11:00</option>
              <option value="12:00">12:00</option>
              <option value="13:00">13:00</option>
              <option value="14:00">14:00</option>
              <option value="15:00">15:00</option>
              <option value="16:00">16:00</option>
              <option value="17:00">17:00</option>
              <option value="18:00">18:00</option>
              <option value="19:00">19:00</option>
              <option value="20:00">20:00</option>
            </select>
          </div>
          
          <button type="submit" id="submitChangeBtn" style="background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; font-weight: bold;" disabled>
            Submit Change Request
          </button>
        </form>
        
        <div id="submitStatus" style="margin-top: 15px; padding: 12px; border-radius: 4px; display: none;"></div>
      </div>
    </div>
    
    <div class="calendar-container">
      <div class="controls">
        <div id="dayControls">
          <label class="date-selector">Date:</label>
          <input type="date" id="dateSelector" />
        </div>
        
        <div id="weekControls" class="hidden">
          <div class="week-navigation">
            <button onclick="changeWeek(-1)">← Previous Week</button>
            <span id="weekDisplay"></span>
            <button onclick="changeWeek(1)">Next Week →</button>
          </div>
        </div>
        
        <button onclick="refreshData()">Refresh Data</button>
        <span id="dataStatus" style="margin-left: 15px; font-size: 0.9em; color: #666;"></span>
      </div>
      
      <div class="calendar-grid day-view" id="calendarGrid">
        <!-- Dynamic grid will be inserted here -->
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxaMATLZvtAxJULI2l3teqb0u6FkBiP8LBuGMV7VrcU2NxMEbH92aj8Q4YI6aZ1GLUm4Q/exec';
    
    const rooms = ["Room 1", "Room 2", "Room 4", "Room 6", "Room 7", "Online"];
    const businessHours = Array.from({length: 13}, (_, i) => `${String(i + 8).padStart(2, '0')}:00`);
    const weekDays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    
    // Global state
    let bookingData = [];
    let currentView = 'day';
    let currentDate = new Date().toISOString().split('T')[0];
    let currentWeekStart = new Date();
    let selectedCounsellor = '';
    window.clientId = null;
    window.bookingToModify = null;

    // Set today's date as default
    document.getElementById('dateSelector').value = currentDate;
    
    // Set current week to start on Monday
    const today = new Date();
    const dayOfWeek = today.getDay();
    let daysToSubtract = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
    currentWeekStart = new Date(today);
    currentWeekStart.setDate(today.getDate() - daysToSubtract);
    currentWeekStart.setHours(0, 0, 0, 0);

    // NEW: Function to check if booking is within 24 hours
    function isBookingWithin24Hours(bookingDate, bookingTime) {
      const now = new Date();
      const bookingDateTime = new Date(`${bookingDate}T${bookingTime}:00`);
      const timeDiff = bookingDateTime.getTime() - now.getTime();
      const hoursDiff = timeDiff / (1000 * 60 * 60);
      return hoursDiff < 24;
    }

    // NEW: Priority loading function for specific counsellor
    async function loadBookingDataWithPriority(priorityCounsellor = null) {
      const statusElement = document.getElementById('dataStatus');
      
      try {
        if (statusElement) statusElement.textContent = 'Loading booking data...';
        
        let url = SCRIPT_URL;
        if (priorityCounsellor) {
          url += `?priority_counsellor=${encodeURIComponent(priorityCounsellor)}`;
          if (statusElement) statusElement.textContent = `Loading ${priorityCounsellor}'s bookings first...`;
        }
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`Failed to fetch data: ${response.statusText}`);
        }
        
        const jsonData = await response.json();
        
        console.log('=== BOOKING DATA DEBUG ===');
        console.log('Total bookings loaded:', jsonData.length);
        if (priorityCounsellor) {
          const priorityBookings = jsonData.filter(b => b.client === priorityCounsellor);
          console.log(`Priority bookings for ${priorityCounsellor}:`, priorityBookings.length);
        }
        console.log('=== END DEBUG ===');
        
        const cachedData = {
          data: jsonData,
          timestamp: Date.now(),
          expiry: Date.now() + (2 * 60 * 1000)
        };
        
        try {
          sessionStorage.setItem('bookingDataCache', JSON.stringify(cachedData));
        } catch (e) {
          console.warn('Could not cache data in sessionStorage:', e);
        }
        
        bookingData = jsonData;
        populateCounsellorDropdown();
        updateCounsellorInfo();
        
        if (statusElement) {
          statusElement.textContent = `Loaded ${jsonData.length} bookings`;
          statusElement.style.color = '#28a745';
          
          setTimeout(() => {
            statusElement.textContent = '';
          }, 3000);
        }
        
        return Promise.resolve();
        
      } catch (error) {
        console.error('Error loading booking data:', error);
        if (statusElement) {
          statusElement.textContent = 'Error loading data';
          statusElement.style.color = '#dc3545';
        }
        
        bookingData = [];
        return Promise.resolve();
      }
    }

    // UPDATED: Modified refresh function to use priority loading
    function refreshData() {
      console.log('Manual refresh triggered');
      try {
        sessionStorage.removeItem('bookingDataCache');
      } catch (e) {
        console.warn('Could not clear cache:', e);
      }
      
      // Use priority loading if a counsellor is selected
      const priorityCounsellor = selectedCounsellor || null;
      loadBookingDataWithPriority(priorityCounsellor).then(() => {
        console.log('Refresh complete, repopulating calendar');
        populateCalendar();
      });
    }

    // UPDATED: Modified prefillForm function to check 24-hour restriction
    function prefillForm(bookingCode, room, date, time) {
      const roomDisplay = document.getElementById('currentRoomDisplay');
      const dateDisplay = document.getElementById('currentDateDisplay');
      const timeDisplay = document.getElementById('currentTimeDisplay');
      const pastNotice = document.getElementById('pastBookingNotice');
      const cancelBtn = document.getElementById('cancelBookingBtn');
      const submitBtn = document.getElementById('submitChangeBtn');
      const newRoomInput = document.getElementById('newRoomInput');
      const newDateInput = document.getElementById('newDateInput');
      const newTimeInput = document.getElementById('newTimeInput');
      
      // Update visible displays
      if (roomDisplay) roomDisplay.textContent = room || '';
      if (dateDisplay) dateDisplay.textContent = date || '';
      if (timeDisplay) timeDisplay.textContent = time || '';
      
      // Update hidden inputs
      document.getElementById('bookingCodeInput').value = bookingCode || '';
      document.getElementById('currentRoomInput').value = room || '';
      document.getElementById('currentDateInput').value = date || '';
      document.getElementById('currentTimeInput').value = time || '';
      
      if (selectedCounsellor) {
        document.getElementById('counsellorNameInput').value = selectedCounsellor;
      }
      
      // NEW: Check 24-hour restriction
      const isWithin24Hours = isBookingWithin24Hours(date, time);
      
      if (isWithin24Hours) {
        // Show notice and disable controls
        pastNotice.classList.remove('hidden');
        cancelBtn.disabled = true;
        submitBtn.disabled = true;
        newRoomInput.disabled = true;
        newDateInput.disabled = true;
        newTimeInput.disabled = true;
      } else {
        // Hide notice and enable controls
        pastNotice.classList.add('hidden');
        cancelBtn.disabled = false;
        submitBtn.disabled = false;
        newRoomInput.disabled = false;
        newDateInput.disabled = false;
        newTimeInput.disabled = false;
        
        // Populate room dropdown
        populateRoomDropdown(room);
      }
      
      // Clear new values
      newRoomInput.value = '';
      newDateInput.value = '';
      newTimeInput.value = '';
      
      console.log('Pre-filled form:', { bookingCode, room, date, time, isWithin24Hours });
    }

    // UPDATED: Modified populateCalendar functions to mark past bookings
    function populateDayView(filteredBookings) {
      const selectedDate = document.getElementById('dateSelector').value;
      const dayBookings = bookingData.filter(booking => booking.date === selectedDate);
      
      dayBookings.forEach(booking => {
        const startHour = parseInt(booking.start.split(':')[0]);
        const endHour = parseInt(booking.end.split(':')[0]);
        const {roomNumber, roomClass} = getRoomMapping(booking);
        
        if (!roomNumber) return;
        
        const isWithin24Hours = isBookingWithin24Hours(booking.date, booking.start);
        
        for (let hour = startHour; hour < endHour; hour++) {
          if (hour >= 8 && hour <= 20) {
            const timeString = `${String(hour).padStart(2, '0')}:00`;
            const cellId = `cell-${roomNumber}-${timeString}`;
            const cell = document.getElementById(cellId);
            
            if (cell) {
              cell.classList.add('booked', roomClass);
              
              // NEW: Add past booking styling
              if (isWithin24Hours) {
                cell.classList.add('past-booking');
              }
              
              if (window.bookingToModify && 
                  (booking.bookingId === window.bookingToModify.bookingId || 
                   booking.code === window.bookingToModify.bookingId) &&
                  booking.date === window.bookingToModify.date &&
                  booking.start === window.bookingToModify.time) {
                cell.classList.add('selected-booking');
              }
              
              cell.innerHTML = `
                <div class="booking-info">${booking.client || ''}</div>
                <div class="client-name">${booking.bookingId || booking.code || ''}</div>
              `;
              
              // UPDATED: Only add click handler if not within 24 hours
              if (!isWithin24Hours) {
                cell.addEventListener('click', function() {
                  const bookingCode = booking.bookingId || booking.code;
                  const roomDisplayName = getRoomDisplayName(booking);
                  
                  prefillForm(bookingCode, roomDisplayName, booking.date, booking.start);
                  
                  document.querySelectorAll('.selected-booking').forEach(c => c.classList.remove('selected-booking'));
                  cell.classList.add('selected-booking');
                  
                  const formContainer = document.querySelector('.form-container');
                  if (formContainer) {
                    formContainer.scrollIntoView({ behavior: 'smooth' });
                  }
                });
              }
            }
          }
        }
      });
    }

    function populateWeekView(filteredBookings) {
      if (!selectedCounsellor) return;
      
      filteredBookings.forEach(booking => {
        const bookingDate = new Date(booking.date + 'T12:00:00');
        const weekStartNoon = new Date(currentWeekStart);
        weekStartNoon.setHours(12, 0, 0, 0);
        
        const msPerDay = 24 * 60 * 60 * 1000;
        const timeDiff = bookingDate.getTime() - weekStartNoon.getTime();
        const daysDiff = Math.round(timeDiff / msPerDay);
        
        if (daysDiff >= 0 && daysDiff <= 6) {
          const startHour = parseInt(booking.start.split(':')[0]);
          const endHour = parseInt(booking.end.split(':')[0]);
          const isWithin24Hours = isBookingWithin24Hours(booking.date, booking.start);
          
          for (let hour = startHour; hour < endHour; hour++) {
            if (hour >= 8 && hour <= 20) {
              const timeString = `${String(hour).padStart(2, '0')}:00`;
              const cellId = `week-cell-${daysDiff}-${timeString}`;
              const cell = document.getElementById(cellId);
              
              if (cell) {
                const {roomClass} = getRoomMapping(booking);
                const roomDisplayName = getRoomDisplayName(booking);
                
                cell.classList.add('booked', roomClass);
                
                // NEW: Add past booking styling
                if (isWithin24Hours) {
                  cell.classList.add('past-booking');
                }
                
                if (window.bookingToModify && 
                    (booking.bookingId === window.bookingToModify.bookingId || 
                     booking.code === window.bookingToModify.bookingId) &&
                    booking.date === window.bookingToModify.date &&
                    booking.start === window.bookingToModify.time) {
                  cell.classList.add('selected-booking');
                }
                
                cell.innerHTML = `
                  <div class="booking-info">${roomDisplayName}</div>
                  <div class="client-name">${booking.bookingId || booking.code || ''}</div>
                `;
                
                // UPDATED: Only add click handler if not within 24 hours
                if (!isWithin24Hours) {
                  cell.addEventListener('click', function() {
                    const bookingCode = booking.bookingId;
                    
                    prefillForm(bookingCode, roomDisplayName, booking.date, booking.start);
                    
                    document.querySelectorAll('.selected-booking').forEach(c => c.classList.remove('selected-booking'));
                    cell.classList.add('selected-booking');
                    
                    const formContainer = document.querySelector('.form-container');
                    if (formContainer) {
                      formContainer.scrollIntoView({ behavior: 'smooth' });
                    }
                  });
                }
              }
            }
          }
        }
      });
    }

    // UPDATED: Modified initial data loading to use priority
    function initializeData() {
      try {
        const cachedData = sessionStorage.getItem('bookingDataCache');
        if (cachedData) {
          const parsedData = JSON.parse(cachedData);
          if (parsedData.expiry > Date.now()) {
            bookingData = parsedData.data;
            populateCounsellorDropdown();
            updateCounsellorInfo();
            populateCalendar();
            return;
          }
        }
      } catch (e) {
        console.warn('Could not load cached data:', e);
      }
      
      // NEW: Use priority loading if counsellor is already selected
      const priorityCounsellor = selectedCounsellor || null;
      loadBookingDataWithPriority(priorityCounsellor).then(() => {
        populateCalendar();
      });
    }

    // [Include all the other existing functions here: formatDateTimeForSimplybookMe, getLocationIdFromRoom, getRoomsForLocation, parseURLParams, populateRoomDropdown, cancelBooking, logCancellationToGoogleSheets, clearBookingForm, convertRoomNameToUnderscore, submitBookingChange, lookupCounsellorId, logChangeToGoogleSheets, updateURL, switchView, filterByCounsellor, updateCounsellorInfo, populateCounsellorDropdown, getWeekStartDate, formatDate, changeWeek, updateWeekDisplay, createCalendarGrid, createDayGrid, createWeekGrid, populateCalendar, getRoomDisplayName, getRoomMapping]

    // Include all remaining functions from your original code...
    // [The rest of the functions remain the same as in your original code]

    // Date selector handler
    document.getElementById('dateSelector').addEventListener('change', function() {
      currentDate = this.value;
      populateCalendar();
      updateURL();
    });

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing...');
      
      setTimeout(() => {
        parseURLParams();
        updateViewButtons();
        updateControlsVisibility();
        
        const grid = document.getElementById('calendarGrid');
        if (grid) {
          grid.className = `calendar-grid ${currentView}-view`;
          createCalendarGrid();
        }
        
        initializeData();
        
        // Set up form handler
        const changeForm = document.getElementById('bookingChangeForm');
        if (changeForm) {
          changeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const changeData = {
              originalBookingCode: document.getElementById('bookingCodeInput').value,
              originalRoom: document.getElementById('currentRoomInput').value,
              originalDate: document.getElementById('currentDateInput').value,
              originalTime: document.getElementById('currentTimeInput').value,
              newRoom: document.getElementById('newRoomInput').value,
              newDate: document.getElementById('newDateInput').value,
              newTime: document.getElementById('newTimeInput').value,
              counsellorName: selectedCounsellor
            };
            
            if (!changeData.newRoom && !changeData.newDate && !changeData.newTime) {
              alert('Please specify what changes you would like to make.');
              return;
            }
            
            if (!changeData.counsellorName) {
              alert('Please select a counsellor first.');
              return;
            }
            
            // Check 24-hour restriction
            if (isBookingWithin24Hours(changeData.originalDate, changeData.originalTime)) {
              alert('This booking is within 24 hours and cannot be modified online. Please contact the centre directly.');
              return;
            }
            
            // Validate location restriction
            if (changeData.newRoom) {
              const originalLocationId = getLocationIdFromRoom(changeData.originalRoom);
              const requestedLocationId = getLocationIdFromRoom(changeData.newRoom);
              
              if (originalLocationId !== requestedLocationId) {
                const originalLocation = originalLocationId === '1' ? 'Buckhurst Hill' : 'Henley';
                const requestedLocation = requestedLocationId === '1' ? 'Buckhurst Hill' : 'Henley';
                
                alert(`Cannot change locations. Your current booking is in ${originalLocation}, but you selected a room in ${requestedLocation}. Please choose a room in the same location.`);
                return;
              }
            }
            
            submitBookingChange(changeData);
          });
        }
        
        if (window.bookingToModify) {
          prefillForm(
            window.bookingToModify.bookingId,
            window.bookingToModify.room,
            window.bookingToModify.date,
            window.bookingToModify.time
          );
          
          setTimeout(() => {
            const formContainer = document.querySelector('.form-container');
            if (formContainer) {
              formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }, 500);
        }
      }, 100);
    });

    // [Add all other remaining functions from your original sections here]
    // For brevity, I'm indicating where the other functions would go
    // Include: formatDateTimeForSimplybookMe, getLocationIdFromRoom, getRoomsForLocation, parseURLParams, etc.
  </script>
</body>
</html>
