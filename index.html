<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Cherry Tree Centre - Room Booking Calendar</title>
  
  <!-- ================================ -->
  <!-- SECTION 1: STYLES AND CSS -->
  <!-- ================================ -->
  <style>
    /* General styles */
    body {
      display: flex;
      margin: 0;
      font-family: Arial, sans-serif;
      height: 100vh;
      flex-direction: column;
    }
    .header {
      background: #f8f9fa;
      padding: 10px 20px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .view-selector {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .view-btn {
      padding: 8px 16px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      border-radius: 4px;
    }
    .view-btn.active {
      background: #007bff;
      color: white;
    }
    .counsellor-filter {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .form-container {
      width: 400px;
      padding: 10px;
      border-right: 1px solid #ccc;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .calendar-container {
      flex: 1;
      overflow: auto;
      padding: 10px;
      max-height: calc(100vh - 80px);
    }
    .controls {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    /* Calendar grid styles */
    .calendar-grid {
      display: grid;
      border: 1px solid #ccc;
      font-size: 0.85em;
      max-width: 100%;
      min-height: 400px;
    }
    .calendar-grid.day-view {
      grid-template-columns: 60px repeat(6, 1fr);
      grid-auto-rows: 35px;
    }
    .calendar-grid.week-view {
      grid-template-columns: 80px repeat(7, 1fr);
      grid-auto-rows: 30px;
    }
    .grid-header {
      background: #f0f0f0;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ccc;
      padding: 2px;
      font-size: 0.9em;
    }
    .time-header {
      background: #f8f8f8;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ccc;
      font-size: 0.8em;
    }
    .grid-cell {
      border: 1px solid #eee;
      padding: 2px;
      font-size: 0.75em;
      position: relative;
      overflow: hidden;
      background: #fff;
      line-height: 1.2;
      cursor: pointer;
    }
    .grid-cell.booked {
      border: 1px solid #333;
    }
    .grid-cell.booked.room-1 {
      background: #d4a5a5;
      border-color: #b89090;
    }
    .grid-cell.booked.room-2 {
      background: #b299d4;
      border-color: #9680c0;
    }
    .grid-cell.booked.room-4 {
      background: #a5d4a5;
      border-color: #90b890;
    }
    .grid-cell.booked.room-6 {
      background: #c8a882;
      border-color: #b5946e;
    }
    .grid-cell.booked.room-7 {
      background: #e6d45a;
      border-color: #d4c347;
    }
    .grid-cell.booked.online {
      background: #7dd87d;
      border-color: #6bc46b;
    }
    .grid-cell.selected-booking {
      box-shadow: 0 0 0 3px #ff6b6b inset, 0 0 8px rgba(255, 107, 107, 0.6);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 3px #ff6b6b inset, 0 0 8px rgba(255, 107, 107, 0.6); }
      50% { box-shadow: 0 0 0 3px #ff9999 inset, 0 0 12px rgba(255, 153, 153, 0.8); }
      100% { box-shadow: 0 0 0 3px #ff6b6b inset, 0 0 8px rgba(255, 107, 107, 0.6); }
    }
    .booking-info {
      font-weight: bold;
      color: #1976d2;
      font-size: 0.8em;
    }
    .client-name {
      color: #666;
      font-size: 0.7em;
    }
    
    /* Form and info styles */
    .date-selector {
      font-weight: bold;
    }
    .week-navigation {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .counsellor-info {
      background: #e8f4f8;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
    }
    .hidden {
      display: none;
    }
    
    /* 24-hour restriction styles */
    .grid-cell.past-booking {
      opacity: 0.5;
      cursor: not-allowed;
      background-color: #f5f5f5 !important;
      color: #999;
    }
    .past-booking-notice {
      background: #f8d7da;
      color: #721c24;
      padding: 8px;
      border-radius: 4px;
      margin-top: 10px;
      font-size: 12px;
      text-align: center;
    }
  </style>
</head>

<body>
  <!-- ================================ -->
  <!-- SECTION 2: HTML STRUCTURE -->
  <!-- ================================ -->
  <div class="header">
    <h2 id="pageTitle">Cherry Tree Centre - Room Booking Calendar</h2>
    <div class="view-selector">
      <button class="view-btn active" onclick="switchView('day')">Day View</button>
      <button class="view-btn" onclick="switchView('week')">Week View</button>
    </div>
    <div class="counsellor-filter hidden" id="counsellorFilterContainer">
      <label>Counsellor:</label>
      <select id="counsellorSelect" onchange="filterByCounsellor()">
        <option value="">All Counsellors</option>
      </select>
    </div>
  </div>

  <div class="main-container">
    <!-- Left panel: Form for modifying bookings -->
    <div class="form-container">
      <div id="counsellorInfo" class="counsellor-info hidden">
        <h3 id="counsellorName"></h3>
        <p id="counsellorSummary"></p>
      </div>
      
      <!-- Custom booking change form -->
      <div style="background: #f9f9f9; padding: 20px; border-radius: 8px;">
        <h3>Modify Booking</h3>
        <p style="margin-bottom: 15px; font-size: 14px; color: #666;">Click on a booking in the calendar to modify it.</p>
        
        <form id="bookingChangeForm">
          <div style="margin-bottom: 15px;">
            <div style="font-size: 14px; line-height: 1.4;">
              <div style="margin-bottom: 8px;"><strong>Current Room:</strong> <span id="currentRoomDisplay"></span></div>
              <div style="margin-bottom: 8px;"><strong>Current Date:</strong> <span id="currentDateDisplay"></span></div>
              <div style="margin-bottom: 8px;"><strong>Current Time:</strong> <span id="currentTimeDisplay"></span></div>
            </div>
          </div>
          
          <!-- Hidden fields for form submission -->
          <input type="hidden" id="bookingCodeInput">
          <input type="hidden" id="currentRoomInput">
          <input type="hidden" id="currentDateInput">
          <input type="hidden" id="currentTimeInput">
          <input type="hidden" id="counsellorNameInput">
          
          <!-- Past booking notice -->
          <div id="pastBookingNotice" class="past-booking-notice hidden">
            This booking is within 24 hours and cannot be modified or cancelled online. Please contact the centre directly.
          </div>
          
          <div style="margin: 20px 0; text-align: center;">
            <button type="button" id="cancelBookingBtn" onclick="cancelBooking()" 
                    style="background: #dc3545; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; width: 100%; margin-bottom: 10px;"
                    disabled>
              Cancel This Appointment
            </button>
            <div id="cancelStatus" style="margin-top: 10px; padding: 8px; border-radius: 4px; display: none; font-size: 12px;"></div>
          </div>
          
          <hr style="margin: 20px 0; border: 1px solid #ddd;">
          <h4 style="margin-bottom: 15px; color: #007bff;">Or Request Changes:</h4>
          
          <div style="margin-bottom: 15px;">
            <label id="roomChangeLabel" style="display: block; font-weight: bold; margin-bottom: 5px;">New Room (if changing):</label>
            <select id="newRoomInput" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
              <option value="">No change</option>
              <option value="Room 1">Room 1</option>
              <option value="Room 2">Room 2</option>
              <option value="Room 4">Room 4</option>
              <option value="Room 6">Room 6</option>
              <option value="Room 7">Room 7</option>
              <option value="Online">Online</option>
            </select>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">New Date (if changing):</label>
            <input type="date" id="newDateInput" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">New Time (if changing):</label>
            <select id="newTimeInput" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
              <option value="">No change</option>
              <option value="08:00">08:00</option>
              <option value="09:00">09:00</option>
              <option value="10:00">10:00</option>
              <option value="11:00">11:00</option>
              <option value="12:00">12:00</option>
              <option value="13:00">13:00</option>
              <option value="14:00">14:00</option>
              <option value="15:00">15:00</option>
              <option value="16:00">16:00</option>
              <option value="17:00">17:00</option>
              <option value="18:00">18:00</option>
              <option value="19:00">19:00</option>
              <option value="20:00">20:00</option>
            </select>
          </div>
          
          <button type="submit" id="submitChangeBtn" style="background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; font-weight: bold;">
            Submit Change Request
          </button>
        </form>
        
        <div id="submitStatus" style="margin-top: 15px; padding: 12px; border-radius: 4px; display: none;"></div>
      </div>
    </div>
    
    <!-- Right panel: Calendar display -->
    <div class="calendar-container">
      <div class="controls">
        <div id="dayControls">
          <label class="date-selector">Date:</label>
          <input type="date" id="dateSelector" />
        </div>
        
        <div id="weekControls" class="hidden">
          <div class="week-navigation">
            <button onclick="changeWeek(-1)">← Previous Week</button>
            <span id="weekDisplay"></span>
            <button onclick="changeWeek(1)">Next Week →</button>
          </div>
        </div>
        
        <button onclick="refreshData()">Refresh Data</button>
        <span id="dataStatus" style="margin-left: 15px; font-size: 0.9em; color: #666;"></span>
      </div>
      
      <div class="calendar-grid day-view" id="calendarGrid">
        <!-- Dynamic grid will be inserted here -->
      </div>
    </div>
  </div>

  <!-- ================================ -->
  <!-- SECTION 3: GLOBAL CONFIGURATION -->
  <!-- ================================ -->
  <script>
    // Google Apps Script configuration
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxaMATLZvtAxJULI2l3teqb0u6FkBiP8LBuGMV7VrcU2NxMEbH92aj8Q4YI6aZ1GLUm4Q/exec';
    
    // Constants for rooms and business hours
    const rooms = ["Room 1", "Room 2", "Room 4", "Room 6", "Room 7", "Online"];
    const businessHours = Array.from({length: 13}, (_, i) => `${String(i + 8).padStart(2, '0')}:00`);
    const weekDays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    
    // Global state variables
    let bookingData = [];
    let currentView = 'day';
    let currentDate = new Date().toISOString().split('T')[0];
    let currentWeekStart = new Date();
    let selectedCounsellor = '';

    // Global variable for client ID from URL
    window.clientId = null;
    // Global variable for booking to modify from URL
    window.bookingToModify = null;

    // Set today's date as default
    document.getElementById('dateSelector').value = currentDate;
    
    // Set current week to start on Monday
    const today = new Date();
    const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.

    // Fix the calculation
    let daysToSubtract;
    if (dayOfWeek === 0) {
      daysToSubtract = 6; // Sunday: go back 6 days
    } else {
      daysToSubtract = dayOfWeek - 1; // Other days: go back to Monday
    }

    currentWeekStart = new Date(today);
    currentWeekStart.setDate(today.getDate() - daysToSubtract);
    currentWeekStart.setHours(0, 0, 0, 0);

    console.log(`Today is ${today.toDateString()} (day ${dayOfWeek}), week starts ${currentWeekStart.toDateString()} (day ${currentWeekStart.getDay()})`);
  </script>

  <!-- ================================ -->
  <!-- SECTION 4: UTILITY FUNCTIONS -->
  <!-- ================================ -->
  <script>
    // 24-hour check function
    function isBookingWithin24Hours(bookingDate, bookingTime) {
      const now = new Date();
      const bookingDateTime = new Date(`${bookingDate}T${bookingTime}:00`);
      const timeDiff = bookingDateTime.getTime() - now.getTime();
      const hoursDiff = timeDiff / (1000 * 60 * 60);
      return hoursDiff < 24;
    }
    
    // Format date and time for SimplybookMe
    function formatDateTimeForSimplybookMe(date, time) {
      if (!date || !time) {
        return '';
      }
      
      // Ensure time has seconds
      let formattedTime = time;
      if (time.length === 5) { // Format like "14:30"
        formattedTime = time + ':00'; // Add seconds
      }
      
      // Return in ISO 8601 format: YYYY-MM-DDTHH:MM:SS
      return `${date}T${formattedTime}`;
    }

    // Get location ID from room name
    function getLocationIdFromRoom(roomName) {
      // Location 2 (Henley) rooms
      const henleyRooms = ['Room_1', 'Room 1', 'Room_2', 'Room 2', 'Room_4', 'Room 4', 'Room_6', 'Room 6', 'Room_7', 'Room 7', 'Car Park'];
      
      if (henleyRooms.includes(roomName)) {
        return '2'; // Henley
      } else {
        return '1'; // Buckhurst Hill (default for Online and other rooms)
      }
    }

    // Get available rooms for a specific location
    function getRoomsForLocation(locationId) {
      if (locationId === '1') {
        // Buckhurst Hill rooms
        return ['Online'];
      } else if (locationId === '2') {
        // Henley rooms
        return ['Room 1', 'Room 2', 'Room 4', 'Room 6', 'Room 7', 'Car Park'];
      }
      return []; // No rooms for unknown location
    }

    // Parse URL parameters
    function parseURLParams() {
      const params = new URLSearchParams(window.location.search);
      const view = params.get('view');
      const counsellor = params.get('counsellor');
      const clientName = params.get('name');
      const clientId = params.get('clientId');
      const date = params.get('date');
      const bookingId = params.get('booking');
      const room = params.get('room');
      const time = params.get('time');
      const modify = params.get('modify');
      
      if (view && (view === 'day' || view === 'week')) {
        currentView = view;
      }
      
      // New format: clientId + name parameters (preferred for client access)
      if (clientId && clientName) {
        selectedCounsellor = decodeURIComponent(clientName);
        window.clientId = clientId; // Store globally for form submission
        console.log('Client session from URL:', { id: clientId, name: selectedCounsellor });
        
        // Hide counsellor dropdown for direct client access
        const counsellorContainer = document.getElementById('counsellorFilterContainer');
        if (counsellorContainer) {
          counsellorContainer.style.display = 'none';
        }
      }
      // Old format: just counsellor name (fallback for admin use)
      else if (counsellor) {
        selectedCounsellor = decodeURIComponent(counsellor);
        window.clientId = null; // Will need lookup for form submission
        console.log('Counsellor set from URL (old format):', selectedCounsellor);
      }
      
      if (date) {
        currentDate = date;
        document.getElementById('dateSelector').value = currentDate;
        // FIX: Create date properly to avoid timezone issues
        // Add 12:00 to avoid date shifting due to timezone
        const dateObj = new Date(date + 'T12:00:00');
        currentWeekStart = getWeekStartDate(dateObj);
      }
      
      // Handle booking modification parameters
      if (modify === 'true' && bookingId && room && date && time) {
        window.bookingToModify = {
          bookingId: bookingId,
          room: decodeURIComponent(room),
          date: date,
          time: decodeURIComponent(time)
        };
        console.log('Booking to modify from URL:', window.bookingToModify);
      }
    }

    // Populate room dropdown based on current booking's location
    function populateRoomDropdown(currentRoom) {
      const newRoomInput = document.getElementById('newRoomInput');
      const roomLabel = document.getElementById('roomChangeLabel');
      if (!newRoomInput) return;
      
      // Get current room's location
      const currentLocationId = getLocationIdFromRoom(currentRoom);
      
      // Get available rooms for this location
      const availableRooms = getRoomsForLocation(currentLocationId);
      
      // Clear existing options
      newRoomInput.innerHTML = '<option value="">No change</option>';
      
      // Add room options for the same location only
      availableRooms.forEach(roomName => {
        // Skip the current room (no point in "changing" to the same room)
        if (roomName !== currentRoom) {
          const option = document.createElement('option');
          option.value = roomName;
          option.textContent = roomName;
          newRoomInput.appendChild(option);
        }
      });
      
      // Update the label to show location restriction
      const locationName = currentLocationId === '1' ? 'Buckhurst Hill' : 'Henley';
      if (roomLabel) {
        roomLabel.textContent = `New Room (if changing) - ${locationName} only:`;
      }
      
      console.log(`Populated room dropdown for ${locationName} (location ${currentLocationId}):`, availableRooms);
    }

    // Convert room display name to underscore format for webhook
    function convertRoomNameToUnderscore(roomName) {
      // Convert "Room 1" to "Room_1", etc.
      if (roomName && roomName.startsWith('Room ')) {
        return roomName.replace('Room ', 'Room_');
      }
      return roomName; // Return as-is for Online, Car Park, etc.
    }

    // Get week start date (Monday)
    function getWeekStartDate(date) {
      const result = new Date(date);
      const day = result.getDay();
      
      // Calculate how many days to subtract to get to Monday
      let daysToSubtract;
      if (day === 0) {
        // Sunday: go back 6 days to get to previous Monday
        daysToSubtract = 6;
      } else {
        // Any other day: go back (day - 1) days to get to Monday
        daysToSubtract = day - 1;
      }
      
      result.setDate(result.getDate() - daysToSubtract);
      result.setHours(0, 0, 0, 0);
      
      console.log(`getWeekStartDate: input day=${day}, subtracting ${daysToSubtract} days, result day=${result.getDay()}`);
      
      return result;
    }

    // Format date as YYYY-MM-DD
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    // Get room display name from booking data
    function getRoomDisplayName(booking) {
      if (booking.room === 'Room_1' || booking.room === '1') return 'Room 1';
      if (booking.room === 'Room_2' || booking.room === '2') return 'Room 2';
      if (booking.room === 'Room_4' || booking.room === '4') return 'Room 4';
      if (booking.room === 'Room_6' || booking.room === '6') return 'Room 6';
      if (booking.room === 'Room_7' || booking.room === '7') return 'Room 7';
      if (booking.location && booking.location.toLowerCase().includes('online')) return 'Online';
      return booking.room || 'Unknown';
    }

    // Get room mapping for CSS classes
    function getRoomMapping(booking) {
      let roomNumber, roomClass;
      
      if (booking.room === 'Room_1' || booking.room === '1') {
        roomNumber = '1'; roomClass = 'room-1';
      } else if (booking.room === 'Room_2' || booking.room === '2') {
        roomNumber = '2'; roomClass = 'room-2';
      } else if (booking.room === 'Room_4' || booking.room === '4') {
        roomNumber = '4'; roomClass = 'room-4';
      } else if (booking.room === 'Room_6' || booking.room === '6') {
        roomNumber = '6'; roomClass = 'room-6';
      } else if (booking.room === 'Room_7' || booking.room === '7') {
        roomNumber = '7'; roomClass = 'room-7';
      } else if (booking.location && booking.location.toLowerCase().includes('online')) {
        roomNumber = 'online'; roomClass = 'online';
      }
      
      return {roomNumber, roomClass};
    }
  </script>

  <!-- ================================ -->
  <!-- SECTION 5: BOOKING FORM FUNCTIONS -->
  <!-- ================================ -->


  
  <!-- ================================ -->
<!-- SECTION 5: BOOKING FORM FUNCTIONS -->
<!-- ================================ -->
<script>
  // Prefill the booking form with selected booking details
  function prefillForm(bookingCode, room, date, time) {
    // Update the visible display spans
    const roomDisplay = document.getElementById('currentRoomDisplay');
    const dateDisplay = document.getElementById('currentDateDisplay');
    const timeDisplay = document.getElementById('currentTimeDisplay');
    
    // Update the hidden form inputs for submission
    const bookingCodeInput = document.getElementById('bookingCodeInput');
    const currentRoomInput = document.getElementById('currentRoomInput');
    const currentDateInput = document.getElementById('currentDateInput');
    const currentTimeInput = document.getElementById('currentTimeInput');
    const counsellorNameInput = document.getElementById('counsellorNameInput');
    
    // Elements for 24-hour restriction
    const pastNotice = document.getElementById('pastBookingNotice');
    const cancelBtn = document.getElementById('cancelBookingBtn');
    const submitBtn = document.getElementById('submitChangeBtn');
    const newRoomInput = document.getElementById('newRoomInput');
    const newDateInput = document.getElementById('newDateInput');
    const newTimeInput = document.getElementById('newTimeInput');
    
    if (!roomDisplay || !dateDisplay || !timeDisplay) {
      console.warn('Display elements not found, cannot pre-fill form');
      return;
    }
    
    // Update visible displays
    roomDisplay.textContent = room || '';
    dateDisplay.textContent = date || '';
    timeDisplay.textContent = time || '';
    
    // Update hidden inputs for form submission
    if (bookingCodeInput) bookingCodeInput.value = bookingCode || '';
    if (currentRoomInput) currentRoomInput.value = room || '';
    if (currentDateInput) currentDateInput.value = date || '';
    if (currentTimeInput) currentTimeInput.value = time || '';
    
    // Auto-fill counsellor name
    if (selectedCounsellor && counsellorNameInput) {
      counsellorNameInput.value = selectedCounsellor;
    } else if (counsellorNameInput) {
      counsellorNameInput.value = 'Please select counsellor from dropdown above';
    }
    
    // Check 24-hour restriction
    const isWithin24Hours = isBookingWithin24Hours(date, time);
    
    if (isWithin24Hours) {
      // Show notice and disable controls
      if (pastNotice) pastNotice.classList.remove('hidden');
      if (cancelBtn) cancelBtn.disabled = true;
      if (submitBtn) submitBtn.disabled = true;
      if (newRoomInput) newRoomInput.disabled = true;
      if (newDateInput) newDateInput.disabled = true;
      if (newTimeInput) newTimeInput.disabled = true;
    } else {
      // Hide notice and enable controls
      if (pastNotice) pastNotice.classList.add('hidden');
      if (cancelBtn) cancelBtn.disabled = false;
      if (submitBtn) submitBtn.disabled = false;
      if (newRoomInput) newRoomInput.disabled = false;
      if (newDateInput) newDateInput.disabled = false;
      if (newTimeInput) newTimeInput.disabled = false;
      
      // Populate room dropdown based on current booking's location
      populateRoomDropdown(room);
    }
    
    // Clear any previous new values
    if (newRoomInput) newRoomInput.value = '';
    if (newDateInput) newDateInput.value = '';
    if (newTimeInput) newTimeInput.value = '';
    
    console.log('Pre-filled form with:');
    console.log('  Booking Code:', bookingCode);
    console.log('  Room:', room);
    console.log('  Date:', date);
    console.log('  Time:', time);
    console.log('  Counsellor:', selectedCounsellor || 'Not set');
    console.log('  Within 24 hours:', isWithin24Hours);
  }

  // Clear the booking form
  function clearBookingForm() {
    document.getElementById('currentRoomDisplay').textContent = '';
    document.getElementById('currentDateDisplay').textContent = '';
    document.getElementById('currentTimeDisplay').textContent = '';
    document.getElementById('bookingCodeInput').value = '';
    document.getElementById('currentRoomInput').value = '';
    document.getElementById('currentDateInput').value = '';
    document.getElementById('currentTimeInput').value = '';
    document.getElementById('counsellorNameInput').value = '';
    document.getElementById('newRoomInput').value = '';
    document.getElementById('newDateInput').value = '';
    document.getElementById('newTimeInput').value = '';
    
    // Disable cancel button
    const cancelBtn = document.getElementById('cancelBookingBtn');
    if (cancelBtn) {
      cancelBtn.disabled = true;
    }
    
    // Hide notice
    const pastNotice = document.getElementById('pastBookingNotice');
    if (pastNotice) {
      pastNotice.classList.add('hidden');
    }
  }

  // UPDATED: Handle booking cancellation with payment status
  async function cancelBooking() {
    const bookingCode = document.getElementById('bookingCodeInput').value;
    const room = document.getElementById('currentRoomInput').value;
    const date = document.getElementById('currentDateInput').value;
    const time = document.getElementById('currentTimeInput').value;
    const counsellorName = selectedCounsellor;
    
    if (!bookingCode || !counsellorName) {
      alert('Please select a booking first by clicking on it in the calendar.');
      return;
    }
    
    // Check 24-hour restriction
    if (isBookingWithin24Hours(date, time)) {
      alert('This booking is within 24 hours and cannot be cancelled online. Please contact the centre directly.');
      return;
    }
    
    // Find the booking in bookingData to get comments and payment status
    const booking = bookingData.find(b => 
      (b.bookingId === bookingCode || b.code === bookingCode) &&
      b.date === date &&
      b.start === time
    );
    
    // Confirmation dialog
    if (!confirm(`Are you sure you want to cancel this appointment?\n\nDate: ${date}\nTime: ${time}\nRoom: ${room}\n\nThis action cannot be undone.`)) {
      return;
    }
    
    const cancelStatusDiv = document.getElementById('cancelStatus');
    
    try {
      cancelStatusDiv.style.display = 'block';
      cancelStatusDiv.style.background = '#fff3cd';
      cancelStatusDiv.style.color = '#856404';
      cancelStatusDiv.style.border = '1px solid #ffeaa7';
      cancelStatusDiv.textContent = 'Processing cancellation...';
      
      // Get counsellor ID
      let counsellorId = window.clientId;
      
      if (!counsellorId) {
        counsellorId = await lookupCounsellorId(counsellorName);
        if (!counsellorId) {
          throw new Error(`Counsellor "${counsellorName}" not found. Please contact support.`);
        }
      }
      
      // Convert room name to underscore format if needed
      let roomForWebhook = room;
      if (room && room.startsWith('Room ')) {
        roomForWebhook = room.replace('Room ', 'Room_');
      }
      
      // Build cancellation payload with payment status
      const cancellationPayload = {
        timestamp: new Date().toISOString(),
        action: 'cancel',
        counsellor_id: counsellorId,
        booking_code: bookingCode,
        original_datetime: `${date}T${time}:00`,
        original_room: roomForWebhook,
        service_id: '2',
        comments: booking ? (booking.comments || '') : '',
        is_paid: booking ? (booking.isPaid ? 'True' : 'No') : 'No'  // NEW: Payment status
      };
      
      console.log('Cancellation payload:', cancellationPayload);
      
      // Send cancellation to webhook
      cancelStatusDiv.textContent = 'Sending cancellation request...';
      const CANCEL_WEBHOOK_URL = 'https://hook.eu2.make.com/p754q5eks857boisu6m3unr6qer6be4t';
      
      const response = await fetch(CANCEL_WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(cancellationPayload)
      });
      
      if (!response.ok) {
        throw new Error(`Cancellation failed: ${response.status} - ${await response.text()}`);
      }
      
      // Log cancellation to Google Sheets
      cancelStatusDiv.textContent = 'Logging cancellation...';
      await logCancellationToGoogleSheets(bookingCode, counsellorName, room, date, time, cancellationPayload);
      
      // Success
      cancelStatusDiv.style.background = '#d4edda';
      cancelStatusDiv.style.color = '#155724';
      cancelStatusDiv.style.border = '1px solid #c3e6cb';
      cancelStatusDiv.textContent = 'Appointment cancelled successfully!';
      
      // Clear the form
      clearBookingForm();
      
      // Refresh calendar data
      setTimeout(() => {
        refreshData();
        cancelStatusDiv.style.display = 'none';
      }, 3000);
      
    } catch (error) {
      console.error('Cancellation error:', error);
      cancelStatusDiv.style.background = '#f8d7da';
      cancelStatusDiv.style.color = '#721c24';
      cancelStatusDiv.style.border = '1px solid #f5c6cb';
      cancelStatusDiv.textContent = `Error: ${error.message}`;
    }
  }
  
  // Log cancellation to Google Sheets
  async function logCancellationToGoogleSheets(bookingCode, counsellorName, room, date, time, payload) {
    try {
      const CHANGE_REQUESTS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwVIQAryAHaD9HfEqAvaxXDo-nd1BSN664E4Kyg1tVWgmOsTfG6VS7JYgHohqN7HQiz/exec';
      
      const formData = new FormData();
      formData.append('action', 'cancelBooking');
      formData.append('timestamp', payload.timestamp);
      formData.append('counsellorName', counsellorName);
      formData.append('bookingCode', bookingCode);
      formData.append('originalRoom', room);
      formData.append('originalDate', date);
      formData.append('originalTime', time);
      formData.append('cancellationReason', 'Client requested cancellation via booking system');
      formData.append('webhookSent', 'Yes');
      formData.append('submissionMethod', 'Direct from HTML - Cancellation');
      
      const response = await fetch(CHANGE_REQUESTS_SCRIPT_URL, {
        method: 'POST',
        body: formData
      });
      
      if (response.ok) {
        console.log('Successfully logged cancellation to Google Sheets');
      } else {
        console.warn('Failed to log cancellation to Google Sheets, but webhook was sent');
      }
      
    } catch (error) {
      console.warn('Google Sheets logging failed:', error);
      // Don't throw error here - the main webhook succeeded
    }
  }

  // UPDATED: Submit booking change request with payment status
  async function submitBookingChange(changeData) {
    const statusDiv = document.getElementById('submitStatus');
    
    try {
      statusDiv.style.display = 'block';
      statusDiv.style.background = '#fff3cd';
      statusDiv.style.color = '#856404';
      statusDiv.style.border = '1px solid #ffeaa7';
      statusDiv.textContent = 'Submitting change request...';
      
      // Get counsellor ID - try URL first, then lookup if needed
      let counsellorId = window.clientId;
      
      if (!counsellorId) {
        counsellorId = await lookupCounsellorId(changeData.counsellorName);
        if (!counsellorId) {
          throw new Error(`Counsellor "${changeData.counsellorName}" not found. Please contact support.`);
        }
      }
      
      // Find the booking in bookingData to get comments and payment status
      const booking = bookingData.find(b => 
        (b.bookingId === changeData.originalBookingCode || b.code === changeData.originalBookingCode) &&
        b.date === changeData.originalDate &&
        b.start === changeData.originalTime
      );
      
      // Convert room names to underscore format for webhook
      const originalRoomUnderscore = convertRoomNameToUnderscore(changeData.originalRoom);
      const newRoomUnderscore = changeData.newRoom ? convertRoomNameToUnderscore(changeData.newRoom) : originalRoomUnderscore;
      
      // Transform room names to IDs (using underscore format)
      const ROOM_MAPPING = {
        'Room_1': '3',
        'Room_2': '7',
        'Room_4': '8',
        'Room_6': '9',
        'Room_7': '10',
        'Car Park': '12',
        'Online': '11', 'Online Counselling': '11'
      };
      
      const originalRoomId = ROOM_MAPPING[originalRoomUnderscore];
      const requestedRoomId = ROOM_MAPPING[newRoomUnderscore];
      
      if (!originalRoomId || !requestedRoomId) {
        throw new Error(`Room mapping failed for "${originalRoomUnderscore}" or "${newRoomUnderscore}"`);
      }
      
      // Get location IDs based on room names (using underscore format)
      const originalLocationId = getLocationIdFromRoom(originalRoomUnderscore);
      const requestedLocationId = getLocationIdFromRoom(newRoomUnderscore);
      
      console.log('Location mapping:', {
        originalRoom: originalRoomUnderscore,
        originalLocationId: originalLocationId,
        requestedRoom: newRoomUnderscore,
        requestedLocationId: requestedLocationId
      });
      
      // Build webhook payload WITH PAYMENT STATUS
      const webhookPayload = {
        timestamp: new Date().toISOString(),
        action: 'modify',  // Clear action identifier for modifications
        counsellor_id: counsellorId,
        original_booking_code: changeData.originalBookingCode,
        original_room: originalRoomUnderscore,  // UPDATED: Use underscore format
        original_room_id: originalRoomId,
        original_location_id: originalLocationId,
        original_datetime: `${changeData.originalDate}T${changeData.originalTime}:00`,
        requested_room: newRoomUnderscore,  // ADDED: Include the requested room name in underscore format
        requested_room_id: requestedRoomId,
        requested_location_id: requestedLocationId,
        requested_datetime: formatDateTimeForSimplybookMe(
          changeData.newDate || changeData.originalDate,
          changeData.newTime || changeData.originalTime
        ),
        service_id: '2',
        comments: booking ? (booking.comments || '') : '',
        is_paid: booking ? (booking.isPaid ? 'True' : 'No') : 'No'  // NEW: Payment status
      };
      
      console.log('Webhook payload:', webhookPayload);
      
      // Send to Make webhook
      statusDiv.textContent = 'Sending to booking system...';
      const MAKE_WEBHOOK_URL = 'https://hook.eu2.make.com/p754q5eks857boisu6m3unr6qer6be4t';
      
      const response = await fetch(MAKE_WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(webhookPayload)
      });
      
      if (!response.ok) {
        throw new Error(`Booking system error: ${response.status} - ${await response.text()}`);
      }
      
      console.log('Make webhook success');
      
      // Log to Google Sheets
      statusDiv.textContent = 'Logging change request...';
      await logChangeToGoogleSheets(changeData, webhookPayload);
      
      // Success
      statusDiv.style.background = '#d4edda';
      statusDiv.style.color = '#155724';
      statusDiv.style.border = '1px solid #c3e6cb';
      statusDiv.textContent = 'Change request submitted successfully!';
      
      // Clear form
      document.getElementById('newRoomInput').value = '';
      document.getElementById('newDateInput').value = '';
      document.getElementById('newTimeInput').value = '';
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 7000);
      
    } catch (error) {
      console.error('Submission error:', error);
      statusDiv.style.background = '#f8d7da';
      statusDiv.style.color = '#721c24';
      statusDiv.style.border = '1px solid #f5c6cb';
      statusDiv.textContent = `Error: ${error.message}`;
    }
  }

  // Fallback counsellor ID lookup for old URL format
  async function lookupCounsellorId(counsellorName) {
    try {
      // First, check if we can find the ID in the loaded booking data
      const booking = bookingData.find(b => b.client === counsellorName && b.clientId);
      if (booking && booking.clientId) {
        console.log(`Found counsellor ID ${booking.clientId} for ${counsellorName} in booking data`);
        return booking.clientId;
      }
      
      // Fallback to hardcoded mapping if needed
      const COUNSELLOR_MAPPING = {
        'Barry Redman': '6', // Updated to correct ID
        // Add other counsellors as needed
      };
      
      return COUNSELLOR_MAPPING[counsellorName] || null;
      
    } catch (error) {
      console.error('Counsellor lookup error:', error);
      return null;
    }
  }

  // Log change to Google Sheets for audit trail
  async function logChangeToGoogleSheets(changeData, webhookPayload) {
    try {
      const CHANGE_REQUESTS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwVIQAryAHaD9HfEqAvaxXDo-nd1BSN664E4Kyg1tVWgmOsTfG6VS7JYgHohqN7HQiz/exec';
      
      const formData = new FormData();
      formData.append('action', 'submitBookingChange');
      formData.append('timestamp', webhookPayload.timestamp);
      formData.append('counsellorName', changeData.counsellorName);
      formData.append('originalBookingCode', changeData.originalBookingCode);
      formData.append('originalRoom', changeData.originalRoom);
      formData.append('originalDate', changeData.originalDate);
      formData.append('originalTime', changeData.originalTime);
      
      const requestedDate = changeData.newDate || changeData.originalDate;
      const requestedTime = changeData.newTime || changeData.originalTime;
      const requestedDateTime = formatDateTimeForSimplybookMe(requestedDate, requestedTime);
      const requestedRoom = changeData.newRoom || changeData.originalRoom;
      
      formData.append('requestedDateTime', requestedDateTime);
      formData.append('requestedRoom', requestedRoom);
      formData.append('webhookSent', 'Yes');
      formData.append('submissionMethod', 'Direct from HTML');
      
      const response = await fetch(CHANGE_REQUESTS_SCRIPT_URL, {
        method: 'POST',
        body: formData
      });
      
      if (response.ok) {
        console.log('Successfully logged to Google Sheets');
      } else {
        console.warn('Failed to log to Google Sheets, but webhook was sent');
      }
      
    } catch (error) {
      console.warn('Google Sheets logging failed:', error);
      // Don't throw error here - the main webhook succeeded
    }
  }
  </script>



<!-- ================================ -->
<!-- SECTION 6: CALENDAR FUNCTIONS -->
<!-- ================================ -->
<script>
  // Switch between day and week views
  function switchView(view) {
    currentView = view;
    
    console.log('Switching to view:', view);
    
    // Update view buttons
    const buttons = document.querySelectorAll('.view-btn');
    if (buttons.length > 0) {
      buttons.forEach(btn => btn.classList.remove('active'));
      // Find the button that was clicked
      const clickedButton = event ? event.target : document.querySelector(`[onclick="switchView('${view}')"]`);
      if (clickedButton) {
        clickedButton.classList.add('active');
      }
    }
    
    // Show/hide controls based on view
    const dayControls = document.getElementById('dayControls');
    const weekControls = document.getElementById('weekControls');
    const counsellorContainer = document.getElementById('counsellorFilterContainer');
    
    if (dayControls) dayControls.classList.toggle('hidden', view !== 'day');
    if (weekControls) weekControls.classList.toggle('hidden', view !== 'week');
    
    // Only show counsellor filter if not using client URL
    if (counsellorContainer && !window.clientId) {
      counsellorContainer.classList.toggle('hidden', false);
    }
    
    // Update grid class
    const grid = document.getElementById('calendarGrid');
    if (grid) {
      grid.className = `calendar-grid ${view}-view`;
    }
    
    // Update page title and info
    updateCounsellorInfo();
    
    // Recreate grid and populate
    createCalendarGrid();
    populateCalendar();
    updateURL();
  }

  // Filter by counsellor
  function filterByCounsellor() {
    selectedCounsellor = document.getElementById('counsellorSelect').value;
    updateCounsellorInfo();
    populateCalendar();
    updateURL();
  }

  // Update counsellor info display
  function updateCounsellorInfo() {
    const infoDiv = document.getElementById('counsellorInfo');
    const nameDiv = document.getElementById('counsellorName');
    const summaryDiv = document.getElementById('counsellorSummary');
    
    if (currentView === 'day') {
      if (selectedCounsellor) {
        nameDiv.textContent = selectedCounsellor;
        summaryDiv.textContent = `Viewing your bookings (Day View) - Only your bookings are modifiable`;
        infoDiv.classList.remove('hidden');
        
        // Different title based on access method
        if (window.clientId) {
          document.getElementById('pageTitle').textContent = `${selectedCounsellor} - Day View`;
        } else {
          document.getElementById('pageTitle').textContent = `${selectedCounsellor} - Your Bookings (Day View)`;
        }
      } else {
        infoDiv.classList.add('hidden');
        document.getElementById('pageTitle').textContent = 'Cherry Tree Centre - Select Counsellor for Day View';
      }
    } else {
      if (selectedCounsellor) {
        const counsellorBookings = bookingData.filter(booking => 
          booking.client.toLowerCase().includes(selectedCounsellor.toLowerCase())
        );
        
        nameDiv.textContent = selectedCounsellor;
        summaryDiv.textContent = `${counsellorBookings.length} bookings found`;
        infoDiv.classList.remove('hidden');
        
        // Personalized title for direct client access
        if (window.clientId) {
          document.getElementById('pageTitle').textContent = `My Bookings - ${selectedCounsellor}`;
        } else {
          document.getElementById('pageTitle').textContent = `Bookings - ${selectedCounsellor}`;
        }
      } else {
        infoDiv.classList.add('hidden');
        
        if (window.clientId) {
          document.getElementById('pageTitle').textContent = 'Please select your name to view bookings';
        } else {
          document.getElementById('pageTitle').textContent = 'Select Counsellor to View Bookings';
        }
      }
    }
  }

  // Populate counsellor dropdown
  function populateCounsellorDropdown() {
    const select = document.getElementById('counsellorSelect');
    const counsellors = new Set();
    
    bookingData.forEach(booking => {
      if (booking.client && booking.client.trim()) {
        counsellors.add(booking.client.trim());
      }
    });
    
    // Clear existing options
    select.innerHTML = '<option value="">Select Counsellor</option>';
    
    // Add counsellor options
    Array.from(counsellors).sort().forEach(counsellor => {
      const option = document.createElement('option');
      option.value = counsellor;
      option.textContent = counsellor;
      if (counsellor === selectedCounsellor) {
        option.selected = true;
      }
      select.appendChild(option);
    });
  }

  // Change week navigation
  function changeWeek(direction) {
    currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
    updateWeekDisplay();
    createCalendarGrid();
    populateCalendar();
    updateURL();
  }

  // Update week display text
  function updateWeekDisplay() {
    const weekEnd = new Date(currentWeekStart);
    weekEnd.setDate(weekEnd.getDate() + 6);
    
    const startStr = currentWeekStart.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: '2-digit', 
      year: 'numeric'
    });
    const endStr = weekEnd.toLocaleDateString('en-GB', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
    
    document.getElementById('weekDisplay').textContent = `${startStr} - ${endStr}`;
  }

  // Create calendar grid based on current view
  function createCalendarGrid() {
    console.log('Creating calendar grid for view:', currentView);
    const grid = document.getElementById("calendarGrid");
    
    if (!grid) {
      console.error('Could not find calendarGrid element!');
      return;
    }
    
    grid.innerHTML = '';
    
    if (currentView === 'day') {
      createDayGrid(grid);
    } else {
      createWeekGrid(grid);
    }
    
    console.log('Calendar grid created successfully!');
  }

  // Create day view grid
  function createDayGrid(grid) {
    console.log('Creating day grid...');
    
    // Empty top-left cell
    const emptyCell = document.createElement("div");
    emptyCell.className = "grid-header";
    emptyCell.textContent = "Time";
    grid.appendChild(emptyCell);
    
    // Header row with room names
    rooms.forEach(room => {
      const header = document.createElement("div");
      header.className = "grid-header";
      header.textContent = room;
      grid.appendChild(header);
    });
    
    console.log('Day grid headers added, adding time rows...');
    
    // Time rows
    businessHours.forEach(time => {
      // Time label
      const timeCell = document.createElement("div");
      timeCell.className = "time-header";
      timeCell.textContent = time;
      grid.appendChild(timeCell);
      
      // Room cells for this time
      rooms.forEach((room) => {
        const cell = document.createElement("div");
        cell.className = "grid-cell";
        
        let roomId;
        if (room === "Room 1") roomId = "1";
        else if (room === "Room 2") roomId = "2";
        else if (room === "Room 4") roomId = "4";
        else if (room === "Room 6") roomId = "6";
        else if (room === "Room 7") roomId = "7";
        else if (room === "Online") roomId = "online";
        
        cell.id = `cell-${roomId}-${time}`;
        grid.appendChild(cell);
      });
    });
    
    console.log('Day grid completed with', grid.children.length, 'cells');
  }

  // Create week view grid
  function createWeekGrid(grid) {
    console.log('Creating week grid...');
    console.log('Week starts on:', formatDate(currentWeekStart), 'Day:', currentWeekStart.getDay());
    
    // Empty top-left cell
    const emptyCell = document.createElement("div");
    emptyCell.className = "grid-header";
    emptyCell.textContent = "Time";
    grid.appendChild(emptyCell);
    
    // Create headers for Monday-Sunday
    const weekDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
    
    for (let i = 0; i < 7; i++) {
      const cellDate = new Date(currentWeekStart);
      cellDate.setDate(currentWeekStart.getDate() + i);
      
      const header = document.createElement("div");
      header.className = "grid-header";
      const dayNum = String(cellDate.getDate()).padStart(2, '0');
      const monthNum = String(cellDate.getMonth() + 1).padStart(2, '0');
      header.textContent = `${weekDays[i]} ${dayNum}/${monthNum}`;
      grid.appendChild(header);
    }
    
    console.log('Week grid headers added, adding time rows...');
    
    // Time rows
    businessHours.forEach(time => {
      // Time header
      const timeCell = document.createElement("div");
      timeCell.className = "time-header";
      timeCell.textContent = time;
      grid.appendChild(timeCell);
      
      // Create 7 cells for each time slot
      for (let day = 0; day < 7; day++) {
        const cell = document.createElement("div");
        cell.className = "grid-cell";
        cell.id = `week-cell-${day}-${time}`;
        grid.appendChild(cell);
      }
    });
    
    updateWeekDisplay();
    console.log('Week grid completed with', grid.children.length, 'cells');
  }

  // Populate calendar with booking data
  function populateCalendar() {
    console.log('Populating calendar - View:', currentView, 'Selected counsellor:', selectedCounsellor, 'Booking data length:', bookingData.length);
    
    // Clear all cells first
    const cells = document.querySelectorAll('.grid-cell');
    console.log('Found', cells.length, 'grid cells to populate');
    
    cells.forEach(cell => {
      cell.innerHTML = '';
      cell.classList.remove('booked', 'room-1', 'room-2', 'room-4', 'room-6', 'room-7', 'online', 'selected-booking', 'past-booking');
    });

    let filteredBookings = bookingData;
    
    // Filter by counsellor only in week view
    if (currentView === 'week' && selectedCounsellor) {
      filteredBookings = bookingData.filter(booking => 
        booking.client && booking.client.toLowerCase().includes(selectedCounsellor.toLowerCase())
      );
      console.log('Filtered bookings for', selectedCounsellor, ':', filteredBookings.length);
    } else if (currentView === 'day') {
      console.log('Day view - showing all bookings:', bookingData.length);
    }
    
    if (currentView === 'day') {
      populateDayView(filteredBookings);
    } else {
      populateWeekView(filteredBookings);
    }
    
    console.log('Calendar population complete');
  }
// UPDATED: Populate day view with payment status display
// CORRECTED: Populate day view with proper date filtering
function populateDayView(filteredBookings) {
  const selectedDate = document.getElementById('dateSelector').value;
  console.log('Populating day view for date:', selectedDate);
  
  // IMPORTANT: Use selectedDate from the input, not a parameter
  const dayBookings = bookingData.filter(booking => {
    console.log(`Checking booking date ${booking.date} against selected ${selectedDate}`);
    return booking.date === selectedDate;
  });
  
  console.log(`Found ${dayBookings.length} bookings for ${selectedDate}`);
  
  dayBookings.forEach(booking => {
    const startHour = parseInt(booking.start.split(':')[0]);
    const endHour = parseInt(booking.end.split(':')[0]);
    
    const {roomNumber, roomClass} = getRoomMapping(booking);
    if (!roomNumber) return;
    
    // Check if booking is within 24 hours
    const isWithin24Hours = isBookingWithin24Hours(booking.date, booking.start);
    
    // Fill cells for the duration of the booking
    for (let hour = startHour; hour < endHour; hour++) {
      if (hour >= 8 && hour <= 20) {
        const timeString = `${String(hour).padStart(2, '0')}:00`;
        const cellId = `cell-${roomNumber}-${timeString}`;
        const cell = document.getElementById(cellId);
        
        if (cell) {
          cell.classList.add('booked', roomClass);
          
          // Add past booking styling
          if (isWithin24Hours) {
            cell.classList.add('past-booking');
          }
          
          // Check if this is the booking to highlight
          if (window.bookingToModify && 
              (booking.bookingId === window.bookingToModify.bookingId || 
               booking.code === window.bookingToModify.bookingId) &&
              booking.date === window.bookingToModify.date &&
              booking.start === window.bookingToModify.time) {
            cell.classList.add('selected-booking');
          }
          
          // Create booking display with payment status
          const bookingCode = booking.bookingId || booking.code || '';
          const paymentIndicator = booking.isPaid ? '' : ' (Old system)';
          
          // Day view: Show client name as main heading
          cell.innerHTML = `
            <div class="booking-info">${booking.client || ''}</div>
            <div class="client-name">${bookingCode}${paymentIndicator}</div>
          `;
          
          // NO CLICK HANDLERS - bookings are not selectable in day view
          cell.style.cursor = 'default';
        }
      }
    }
  });
}

// UPDATED: Populate week view with payment status display
function populateWeekView(filteredBookings) {
  // If no counsellor selected in week view, don't show any bookings
  if (!selectedCounsellor) {
    return;
  }
  
  console.log('Populating week view, week starts:', formatDate(currentWeekStart));
  
  // For each booking, calculate which day column it belongs in
  filteredBookings.forEach(booking => {
    // Parse the booking date
    const bookingDate = new Date(booking.date + 'T12:00:00');
    
    // Create a date for the week start at noon to match
    const weekStartNoon = new Date(currentWeekStart);
    weekStartNoon.setHours(12, 0, 0, 0);
    
    // Calculate days from week start
    const msPerDay = 24 * 60 * 60 * 1000;
    const timeDiff = bookingDate.getTime() - weekStartNoon.getTime();
    const daysDiff = Math.round(timeDiff / msPerDay);
    
    console.log(`Booking on ${booking.date}: daysDiff=${daysDiff}, client=${booking.client}`);
    
    // Only show bookings within this week (0=Mon through 6=Sun)
    if (daysDiff >= 0 && daysDiff <= 6) {
      const startHour = parseInt(booking.start.split(':')[0]);
      const endHour = parseInt(booking.end.split(':')[0]);
      
      // Check if booking is within 24 hours
      const isWithin24Hours = isBookingWithin24Hours(booking.date, booking.start);
      
      for (let hour = startHour; hour < endHour; hour++) {
        if (hour >= 8 && hour <= 20) {
          const timeString = `${String(hour).padStart(2, '0')}:00`;
          const cellId = `week-cell-${daysDiff}-${timeString}`;
          const cell = document.getElementById(cellId);
          
          if (cell) {
            const {roomClass} = getRoomMapping(booking);
            const roomDisplayName = getRoomDisplayName(booking);
            
            cell.classList.add('booked', roomClass);
            
            // Add past booking styling
            if (isWithin24Hours) {
              cell.classList.add('past-booking');
            }
            
            // Check if this is the booking to highlight
            if (window.bookingToModify && 
                (booking.bookingId === window.bookingToModify.bookingId || 
                 booking.code === window.bookingToModify.bookingId) &&
                booking.date === window.bookingToModify.date &&
                booking.start === window.bookingToModify.time) {
              cell.classList.add('selected-booking');
            }
            
            // NEW: Create booking display with payment status
            const bookingCode = booking.bookingId || booking.code || '';
            const paymentIndicator = booking.isPaid ? '' : ' (Old system)';
            
            // Week view: Show room name as main heading
            cell.innerHTML = `
              <div class="booking-info">${roomDisplayName}</div>
              <div class="client-name">${bookingCode}${paymentIndicator}</div>
            `;
            
            // Add click handler only if not within 24 hours
            if (!isWithin24Hours) {
              cell.addEventListener('click', function() {
                const bookingCode = booking.bookingId;
                const room = roomDisplayName;
                const date = booking.date;
                const time = booking.start;
                
                prefillForm(bookingCode, room, date, time);
                
                // Remove selected-booking class from all cells
                document.querySelectorAll('.selected-booking').forEach(c => c.classList.remove('selected-booking'));
                // Add selected-booking class to clicked cell
                cell.classList.add('selected-booking');
                
                // Scroll to form for better UX
                const formContainer = document.querySelector('.form-container');
                if (formContainer) {
                  formContainer.scrollIntoView({ behavior: 'smooth' });
                }
              });
            }
          }
        }
      }
    }
  });
}

</script>

  

  <!-- ================================ -->
  <!-- SECTION 7: DATA MANAGEMENT FUNCTIONS -->
  <!-- ================================ -->
  <script>
    // Load booking data with priority for specific counsellor
    async function loadBookingDataWithPriority(priorityCounsellor = null) {
      const statusElement = document.getElementById('dataStatus');
      
      try {
        if (statusElement) statusElement.textContent = 'Loading booking data...';
        
        let url = SCRIPT_URL;
        if (priorityCounsellor) {
          url += `?priority_counsellor=${encodeURIComponent(priorityCounsellor)}`;
          if (statusElement) statusElement.textContent = `Loading ${priorityCounsellor}'s bookings first...`;
        }
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`Failed to fetch data: ${response.statusText}`);
        }
        
        const jsonData = await response.json();
        
        console.log('=== BOOKING DATA DEBUG ===');
        console.log('Total bookings loaded:', jsonData.length);
        if (priorityCounsellor) {
          const priorityBookings = jsonData.filter(b => b.client === priorityCounsellor);
          console.log(`Priority bookings for ${priorityCounsellor}:`, priorityBookings.length);
        }
        if (jsonData.length > 0) {
          console.log('Sample booking (first one):');
          console.log('Full booking object:', jsonData[0]);
          console.log('Available fields:', Object.keys(jsonData[0]));
          
          // Check the date format
          console.log('First booking date:', jsonData[0].date);
          const testDate = new Date(jsonData[0].date + 'T12:00:00');
          console.log('Parsed as:', testDate.toString());
          console.log('Day of week:', testDate.getDay(), '(0=Sun, 1=Mon, etc.)');
        }
        console.log('=== END DEBUG ===');
        
        const cachedData = {
          data: jsonData,
          timestamp: Date.now(),
          expiry: Date.now() + (2 * 60 * 1000)
        };
        
        try {
          sessionStorage.setItem('bookingDataCache', JSON.stringify(cachedData));
        } catch (e) {
          console.warn('Could not cache data in sessionStorage:', e);
        }
        
        bookingData = jsonData;
        populateCounsellorDropdown();
        updateCounsellorInfo();
        
        if (statusElement) {
          let statusText = `Loaded ${jsonData.length} bookings`;
          if (priorityCounsellor) {
            const priorityCount = jsonData.filter(b => b.client === priorityCounsellor).length;
            statusText += ` (${priorityCount} for ${priorityCounsellor} loaded first)`;
          }
          statusElement.textContent = statusText;
          statusElement.style.color = '#28a745';
          
          setTimeout(() => {
            statusElement.textContent = '';
          }, 3000);
        }
        
        return Promise.resolve();
        
      } catch (error) {
        console.error('Error loading booking data:', error);
        if (statusElement) {
          statusElement.textContent = 'Error loading data';
          statusElement.style.color = '#dc3545';
        }
        
        bookingData = [];
        return Promise.resolve();
      }
    }

    // Load booking data
    async function loadBookingData() {
      // Use priority loading if a counsellor is selected
      const priorityCounsellor = selectedCounsellor || null;
      return loadBookingDataWithPriority(priorityCounsellor);
    }

    // Refresh data manually
    function refreshData() {
      console.log('Manual refresh triggered');
      try {
        sessionStorage.removeItem('bookingDataCache');
      } catch (e) {
        console.warn('Could not clear cache:', e);
      }
      
      // Use priority loading if a counsellor is selected
      const priorityCounsellor = selectedCounsellor || null;
      loadBookingDataWithPriority(priorityCounsellor).then(() => {
        console.log('Refresh complete, repopulating calendar');
        populateCalendar();
      });
    }

    // Update URL with current parameters
    function updateURL() {
      const params = new URLSearchParams();
      params.set('view', currentView);
      
      // Include client parameters if available
      if (window.clientId && selectedCounsellor) {
        params.set('clientId', window.clientId);
        params.set('name', encodeURIComponent(selectedCounsellor));
      } else if (selectedCounsellor) {
        params.set('counsellor', encodeURIComponent(selectedCounsellor));
      }
      
      if (currentView === 'day') {
        params.set('date', document.getElementById('dateSelector').value);
      } else {
        params.set('date', formatDate(currentWeekStart));
      }
      
      const newURL = window.location.pathname + '?' + params.toString();
      window.history.replaceState({}, '', newURL);
    }

    // Initialize view buttons
    function updateViewButtons() {
      const dayBtn = document.querySelector('[onclick="switchView(\'day\')"]');
      const weekBtn = document.querySelector('[onclick="switchView(\'week\')"]');
      
      if (dayBtn && weekBtn) {
        dayBtn.classList.toggle('active', currentView === 'day');
        weekBtn.classList.toggle('active', currentView === 'week');
      }
    }

    // Update controls visibility based on view
    function updateControlsVisibility() {
      const dayControls = document.getElementById('dayControls');
      const weekControls = document.getElementById('weekControls');
      const counsellorContainer = document.getElementById('counsellorFilterContainer');
      
      if (dayControls) dayControls.classList.toggle('hidden', currentView !== 'day');
      if (weekControls) weekControls.classList.toggle('hidden', currentView !== 'week');
      
      // Only show counsellor filter if not using client URL
      if (counsellorContainer && !window.clientId) {
        counsellorContainer.classList.toggle('hidden', false);
      } else if (counsellorContainer && window.clientId) {
        counsellorContainer.classList.toggle('hidden', true);
      }
    }

    // Initialize data
    function initializeData() {
      // Try to load from cache first
      try {
        const cachedData = sessionStorage.getItem('bookingDataCache');
        if (cachedData) {
          const parsedData = JSON.parse(cachedData);
          if (parsedData.expiry > Date.now()) {
            bookingData = parsedData.data;
            populateCounsellorDropdown();
            updateCounsellorInfo();
            populateCalendar();
            return;
          }
        }
      } catch (e) {
        console.warn('Could not load cached data:', e);
      }
      
      // Load fresh data with priority if counsellor is already selected
      const priorityCounsellor = selectedCounsellor || null;
      loadBookingDataWithPriority(priorityCounsellor).then(() => {
        populateCalendar();
      });
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing...');
      
      setTimeout(() => {
        // Parse URL parameters first
        parseURLParams();
        
        // Set initial view state
        updateViewButtons();
        updateControlsVisibility();
        
        // Set grid class and create grid
        const grid = document.getElementById('calendarGrid');
        if (grid) {
          grid.className = `calendar-grid ${currentView}-view`;
          createCalendarGrid();
        } else {
          console.error('Calendar grid element not found!');
        }
        
        // Load data and populate calendar
        initializeData();
        
        // Set up booking change form handler with location validation
        const changeForm = document.getElementById('bookingChangeForm');
        if (changeForm) {
          changeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const changeData = {
              originalBookingCode: document.getElementById('bookingCodeInput').value,
              originalRoom: document.getElementById('currentRoomInput').value,
              originalDate: document.getElementById('currentDateInput').value,
              originalTime: document.getElementById('currentTimeInput').value,
              newRoom: document.getElementById('newRoomInput').value,
              newDate: document.getElementById('newDateInput').value,
              newTime: document.getElementById('newTimeInput').value,
              counsellorName: selectedCounsellor
            };
            
            if (!changeData.newRoom && !changeData.newDate && !changeData.newTime) {
              alert('Please specify what changes you would like to make.');
              return;
            }
            
            if (!changeData.counsellorName) {
              alert('Please select a counsellor first.');
              return;
            }
            
            // Check 24-hour restriction
            if (isBookingWithin24Hours(changeData.originalDate, changeData.originalTime)) {
              alert('This booking is within 24 hours and cannot be modified online. Please contact the centre directly.');
              return;
            }
            
            // Validate location restriction
            if (changeData.newRoom) {
              const originalLocationId = getLocationIdFromRoom(changeData.originalRoom);
              const requestedLocationId = getLocationIdFromRoom(changeData.newRoom);
              
              if (originalLocationId !== requestedLocationId) {
                const originalLocation = originalLocationId === '1' ? 'Buckhurst Hill' : 'Henley';
                const requestedLocation = requestedLocationId === '1' ? 'Buckhurst Hill' : 'Henley';
                
                alert(`Cannot change locations. Your current booking is in ${originalLocation}, but you selected a room in ${requestedLocation}. Please choose a room in the same location.`);
                return;
              }
            }
            
            submitBookingChange(changeData);
          });
        }
        
		// Date selector handler - FIXED
document.getElementById('dateSelector').addEventListener('change', function() {
  currentDate = this.value;
  console.log('Date changed to:', currentDate);
  populateCalendar();
  updateURL();
});
		
        // If there's a booking to modify from URL, prefill the form
        if (window.bookingToModify) {
          console.log('Auto-filling form from URL parameters:', window.bookingToModify);
          
          prefillForm(
            window.bookingToModify.bookingId,
            window.bookingToModify.room,
            window.bookingToModify.date,
            window.bookingToModify.time
          );
          
          // Scroll to form after a short delay to ensure everything is rendered
          setTimeout(() => {
            const formContainer = document.querySelector('.form-container');
            if (formContainer) {
              formContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          }, 500);
        }
      }, 100);
    });
  </script>
</body>
</html>
