<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Cherry Tree Centre - Room Booking Calendar</title>
  <style>
    body {
      display: flex;
      margin: 0;
      font-family: Arial, sans-serif;
      height: 100vh;
    }
    .form-container {
      width: 400px;
      padding: 10px;
      border-right: 1px solid #ccc;
      box-sizing: border-box;
    }
    .calendar-container {
      flex: 1;
      overflow: auto;
      padding: 10px;
      max-height: calc(100vh - 20px);
    }
    .controls {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: 60px repeat(6, 1fr);
      grid-auto-rows: 35px;
      border: 1px solid #ccc;
      font-size: 0.85em;
      max-width: 100%;
    }
    .grid-header {
      background: #f0f0f0;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ccc;
      padding: 2px;
      font-size: 0.9em;
    }
    .time-header {
      background: #f8f8f8;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ccc;
      font-size: 0.8em;
    }
    .grid-cell {
      border: 1px solid #eee;
      padding: 2px;
      font-size: 0.75em;
      position: relative;
      overflow: hidden;
      background: #fff;
      line-height: 1.2;
    }
    .grid-cell.booked {
      border: 1px solid #333;
    }
    .grid-cell.booked.room-1 {
      background: #d4a5a5; /* Dusky pink */
      border-color: #b89090;
    }
    .grid-cell.booked.room-2 {
      background: #b299d4; /* Purple */
      border-color: #9680c0;
    }
    .grid-cell.booked.room-4 {
      background: #a5d4a5; /* Green */
      border-color: #90b890;
    }
    .grid-cell.booked.room-6 {
      background: #c8a882; /* Brown */
      border-color: #b5946e;
    }
    .grid-cell.booked.room-7 {
      background: #e6d45a; /* Gold */
      border-color: #d4c347;
    }
    .grid-cell.booked.online {
      background: #7dd87d; /* Green for online counselling */
      border-color: #6bc46b;
    }
    .booking-info {
      font-weight: bold;
      color: #1976d2;
      font-size: 0.8em;
    }
    .client-name {
      color: #666;
      font-size: 0.7em;
    }
    .date-selector {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="form-container">
    <iframe
      src="https://docs.google.com/forms/d/e/1FAIpQLSeO8S579NUfjFk9IjyiKllFWt0FHOF4TX6KXR5VxpQO3jq9tA/viewform?embedded=true"
      width="100%"
      height="100%"
      frameborder="0"
      marginheight="0"
      marginwidth="0"
      title="Change Booking Form">
      Loadingâ€¦
    </iframe>
  </div>
  <div class="calendar-container">
    <div class="controls">
      <label class="date-selector">Date:</label>
      <input type="date" id="dateSelector" />
      <button onclick="refreshData()">Refresh Data</button>
      <span id="dataStatus" style="margin-left: 15px; font-size: 0.9em; color: #666;"></span>
    </div>
    <div class="calendar-grid" id="calendarGrid">
      <!-- Dynamic grid will be inserted here -->
    </div>
  </div>

  <script>
    // Your Google Apps Script configuration
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwUM0zUG1P4YFHTQy60yqyCUTY-JjWlKucBxRaWD8gmppRzdeHf9Lgx-nQwl0RqdT_Org/exec';
    
    const rooms = ["Room 1", "Room 2", "Room 4", "Room 6", "Room 7", "Online"];
    const times = Array.from({length: 13}, (_, i) => `${String(i + 8).padStart(2, '0')}:00`); // 8am to 8pm (13 hours)
    let bookingData = [];
    let currentDate = new Date().toISOString().split('T')[0];

    // Set today's date as default
    document.getElementById('dateSelector').value = currentDate;

    function createCalendarGrid() {
      console.log('Creating calendar grid...');
      const grid = document.getElementById("calendarGrid");
      
      if (!grid) {
        console.error('Could not find calendarGrid element!');
        return;
      }
      
      console.log('Grid element found, adding headers...');
      
      // Empty top-left cell
      const emptyCell = document.createElement("div");
      emptyCell.className = "grid-header";
      emptyCell.textContent = "Time";
      grid.appendChild(emptyCell);
      
      // Header row with room names
      rooms.forEach(room => {
        const header = document.createElement("div");
        header.className = "grid-header";
        header.textContent = room;
        grid.appendChild(header);
      });
      
      console.log('Headers added, adding time rows...');
      
      // Time rows (13 hours: 8am to 8pm)
      times.forEach(time => {
        // Time label
        const timeCell = document.createElement("div");
        timeCell.className = "time-header";
        timeCell.textContent = time;
        grid.appendChild(timeCell);
        
        // Room cells for this time
        rooms.forEach((room) => {
          const cell = document.createElement("div");
          cell.className = "grid-cell";
          
          // Map room names to IDs
          let roomId;
          if (room === "Room 1") roomId = "1";
          else if (room === "Room 2") roomId = "2";
          else if (room === "Room 4") roomId = "4";
          else if (room === "Room 6") roomId = "6";
          else if (room === "Room 7") roomId = "7";
          else if (room === "Online") roomId = "online";
          
          cell.id = `cell-${roomId}-${time}`;
          grid.appendChild(cell);
        });
      });
      
      console.log('Calendar grid created successfully!');
    }

    function populateCalendar() {
      // Clear all cells first
      const cells = document.querySelectorAll('.grid-cell');
      cells.forEach(cell => {
        cell.innerHTML = '';
        cell.classList.remove('booked', 'room-1', 'room-2', 'room-4', 'room-6', 'room-7', 'online');
      });

      const selectedDate = document.getElementById('dateSelector').value;
      
      // Filter bookings for selected date
      const dayBookings = bookingData.filter(booking => booking.date === selectedDate);
      
      dayBookings.forEach(booking => {
        const startHour = parseInt(booking.start.split(':')[0]);
        const endHour = parseInt(booking.end.split(':')[0]);
        
        // Handle different room formats and map to display positions
        let roomNumber;
        let roomClass;
        
        if (booking.room === 'Room_1' || booking.room === '1') {
          roomNumber = '1';
          roomClass = 'room-1';
        } else if (booking.room === 'Room_2' || booking.room === '2') {
          roomNumber = '2';
          roomClass = 'room-2';
        } else if (booking.room === 'Room_4' || booking.room === '4') {
          roomNumber = '4';
          roomClass = 'room-4';
        } else if (booking.room === 'Room_6' || booking.room === '6') {
          roomNumber = '6';
          roomClass = 'room-6';
        } else if (booking.room === 'Room_7' || booking.room === '7') {
          roomNumber = '7';
          roomClass = 'room-7';
        } else if (booking.location && booking.location.toLowerCase().includes('online')) {
          roomNumber = 'online';
          roomClass = 'online';
        } else {
          // Skip rooms 3, 5 or unknown rooms
          return;
        }
        
        // Fill cells for the duration of the booking (only within business hours)
        for (let hour = startHour; hour < endHour; hour++) {
          // Only show bookings within business hours (8am-8pm)
          if (hour >= 8 && hour <= 20) {
            const timeString = `${String(hour).padStart(2, '0')}:00`;
            const cellId = `cell-${roomNumber}-${timeString}`;
            const cell = document.getElementById(cellId);
            
            if (cell) {
              cell.classList.add('booked', roomClass);
              cell.innerHTML = `
                <div class="booking-info">${booking.code || ''}</div>
                <div class="client-name">${booking.client || ''}</div>
              `;
            }
          }
        }
      });
    }

    async function loadBookingData() {
      const statusElement = document.getElementById('dataStatus');
      
      try {
        statusElement.textContent = 'Loading booking data...';
        console.log('Fetching data from Apps Script...');
        
        const response = await fetch(SCRIPT_URL);
        
        if (!response.ok) {
          throw new Error(`Failed to fetch data: ${response.statusText}`);
        }
        
        const jsonData = await response.json();
        console.log('JSON data loaded successfully:', jsonData.length, 'bookings');
        
        bookingData = jsonData;
        populateCalendar();
        
        statusElement.textContent = `Loaded ${jsonData.length} bookings`;
        statusElement.style.color = '#28a745';
        
        // Clear status after 3 seconds
        setTimeout(() => {
          statusElement.textContent = '';
        }, 3000);
        
      } catch (error) {
        console.error('Error loading booking data:', error);
        statusElement.textContent = 'Error loading data';
        statusElement.style.color = '#dc3545';
        
        alert(`Error loading booking data: ${error.message}\n\nPlease check that your Google Apps Script is deployed correctly.`);
        bookingData = [];
        populateCalendar();
      }
    }

    function refreshData() {
      loadBookingData();
    }

    // Remove the old parseCSV function since we're using JSON now

    // Date selector handler
    document.getElementById('dateSelector').addEventListener('change', populateCalendar);

    // Initialize calendar with debugging
    console.log('Starting calendar initialization...');
    
    // Wait for page to fully load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, creating calendar grid...');
      createCalendarGrid();
      console.log('Grid created, loading booking data...');
      loadBookingData();
    });
    
    // Fallback if DOMContentLoaded already fired
    if (document.readyState === 'loading') {
      // Still loading, wait for DOMContentLoaded
    } else {
      // Already loaded
      console.log('Page already loaded, initializing immediately...');
      createCalendarGrid();
      loadBookingData();
    }
  </script>
</body>
</html>
