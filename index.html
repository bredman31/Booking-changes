// Add this function to handle booking clicks
function handleBookingClick(booking, room, date, startTime) {
    // Extract booking data
    const bookingCode = booking.finalBookingId || booking.originalBookingCode || '';
    const roomName = room;
    const bookingDate = date;
    const time = startTime;
    
    // Pre-fill the form with the clicked booking data
    preFillForm(bookingCode, roomName, bookingDate, time);
    
    // Scroll to the form for better UX
    const formContainer = document.getElementById('google-form-container');
    if (formContainer) {
        formContainer.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Optional: Add visual feedback
    showFormStatus(`Form updated with booking: ${roomName}, ${formatDate(bookingDate)}, ${time}`);
}

// Enhanced preFillForm function to work with dynamic data
function preFillForm(bookingCode, room, date, time) {
    const iframe = document.getElementById('google-form');
    if (!iframe) return;
    
    // Build the pre-filled form URL
    const baseUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSca60SAUPvDP1dHgYETrd-HYOqIlFnTs6ulM-dtPnIwNG6h9w/viewform';
    const params = new URLSearchParams({
        'entry.318804641': bookingCode,  // Booking Code (Column H)
        'entry.491164679': room,         // Room
        'entry.1519263716': date,        // Date (YYYY-MM-DD)
        'entry.438982955': time          // Time (HH:MM)
    });
    
    const preFilledUrl = `${baseUrl}?${params.toString()}`;
    iframe.src = preFilledUrl;
    
    console.log('Form pre-filled with:', { bookingCode, room, date, time });
}

// Enhanced booking rendering in the week view
function renderWeeklyBookingsForRoom(bookings, room, startDate) {
    const container = document.getElementById(`${room.toLowerCase().replace(' ', '')}-bookings`);
    if (!container) return;
    
    container.innerHTML = '';
    
    // Create time slots for the week
    for (let day = 0; day < 7; day++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + day);
        const dateStr = currentDate.toISOString().split('T')[0];
        
        const dayBookings = bookings.filter(booking => 
            booking.room === room && 
            booking.date === dateStr
        );
        
        dayBookings.forEach(booking => {
            const bookingElement = createClickableBookingElement(booking, room, dateStr);
            container.appendChild(bookingElement);
        });
    }
}

// Create clickable booking elements
function createClickableBookingElement(booking, room, date) {
    const bookingDiv = document.createElement('div');
    bookingDiv.className = 'booking-slot clickable-booking';
    bookingDiv.style.cssText = `
        background-color: ${getRoomColor(room)};
        color: white;
        padding: 8px;
        margin: 2px 0;
        border-radius: 4px;
        cursor: pointer;
        transition: opacity 0.2s, transform 0.1s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    `;
    
    // Add hover effects
    bookingDiv.addEventListener('mouseenter', function() {
        this.style.opacity = '0.8';
        this.style.transform = 'translateY(-1px)';
    });
    
    bookingDiv.addEventListener('mouseleave', function() {
        this.style.opacity = '1';
        this.style.transform = 'translateY(0)';
    });
    
    // Format the booking display
    const startTime = booking.startDateTime.split(' ')[1].substring(0, 5); // Extract HH:MM
    const endTime = booking.endDateTime.split(' ')[1].substring(0, 5);
    
    bookingDiv.innerHTML = `
        <div style="font-weight: bold; font-size: 12px;">
            ${startTime}-${endTime}
        </div>
        <div style="font-size: 11px; margin-top: 2px;">
            ${booking.clientCounsellorName || 'Booking'}
        </div>
        <div style="font-size: 10px; opacity: 0.8; margin-top: 1px;">
            Click to modify
        </div>
    `;
    
    // Add click handler
    bookingDiv.addEventListener('click', function() {
        handleBookingClick(booking, room, date, startTime);
        
        // Visual feedback for the click
        this.style.transform = 'scale(0.95)';
        setTimeout(() => {
            this.style.transform = 'translateY(0)';
        }, 150);
    });
    
    // Position the booking in the grid
    const startHour = parseInt(startTime.split(':')[0]);
    const startMinute = parseInt(startTime.split(':')[1]);
    const topPosition = ((startHour - 8) * 60 + startMinute) * (50 / 60); // 50px per hour
    
    bookingDiv.style.position = 'absolute';
    bookingDiv.style.top = `${topPosition}px`;
    bookingDiv.style.left = '0';
    bookingDiv.style.right = '0';
    
    return bookingDiv;
}

// Add status message display
function showFormStatus(message) {
    let statusDiv = document.getElementById('form-status');
    if (!statusDiv) {
        statusDiv = document.createElement('div');
        statusDiv.id = 'form-status';
        statusDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 12px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            font-size: 14px;
            transition: opacity 0.3s;
        `;
        document.body.appendChild(statusDiv);
    }
    
    statusDiv.textContent = message;
    statusDiv.style.opacity = '1';
    
    // Hide after 3 seconds
    setTimeout(() => {
        statusDiv.style.opacity = '0';
        setTimeout(() => {
            if (statusDiv.parentNode) {
                statusDiv.parentNode.removeChild(statusDiv);
            }
        }, 300);
    }, 3000);
}

// Enhanced CSS for clickable bookings (add to your existing styles)
const clickableBookingStyles = `
.clickable-booking {
    user-select: none;
    position: relative;
}

.clickable-booking:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.2) !important;
}

.clickable-booking:active {
    transform: scale(0.95) !important;
}

.week-view .booking-slot {
    min-height: 40px;
}

#form-status {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
`;

// Add the styles to the page
function addClickableBookingStyles() {
    const styleSheet = document.createElement('style');
    styleSheet.textContent = clickableBookingStyles;
    document.head.appendChild(styleSheet);
}

// Initialize the enhanced functionality
function initializeClickableBookings() {
    addClickableBookingStyles();
    
    // If we're in week view, make sure bookings are clickable
    if (getUrlParameter('view') === 'week' || document.body.classList.contains('week-view')) {
        console.log('Clickable bookings initialized for week view');
    }
}

// Call this when the page loads
document.addEventListener('DOMContentLoaded', initializeClickableBookings);
