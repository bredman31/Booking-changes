<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Cherry Tree Centre - Room Booking Calendar</title>
  <style>
    body {
      display: flex;
      margin: 0;
      font-family: Arial, sans-serif;
      height: 100vh;
      flex-direction: column;
    }
    .header {
      background: #f8f9fa;
      padding: 10px 20px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .view-selector {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .view-btn {
      padding: 8px 16px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      border-radius: 4px;
    }
    .view-btn.active {
      background: #007bff;
      color: white;
    }
    .counsellor-filter {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    .form-container {
      width: 400px;
      padding: 10px;
      border-right: 1px solid #ccc;
      box-sizing: border-box;
      overflow-y: auto;
    }
    .calendar-container {
      flex: 1;
      overflow: auto;
      padding: 10px;
      max-height: calc(100vh - 80px);
    }
    .controls {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .calendar-grid {
      display: grid;
      border: 1px solid #ccc;
      font-size: 0.85em;
      max-width: 100%;
      min-height: 400px;
    }
    .calendar-grid.day-view {
      grid-template-columns: 60px repeat(6, 1fr);
      grid-auto-rows: 35px;
    }
    .calendar-grid.week-view {
      grid-template-columns: 80px repeat(7, 1fr);
      grid-auto-rows: 30px;
    }
    .grid-header {
      background: #f0f0f0;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ccc;
      padding: 2px;
      font-size: 0.9em;
    }
    .time-header {
      background: #f8f8f8;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ccc;
      font-size: 0.8em;
    }
    .grid-cell {
      border: 1px solid #eee;
      padding: 2px;
      font-size: 0.75em;
      position: relative;
      overflow: hidden;
      background: #fff;
      line-height: 1.2;
      cursor: pointer;
    }
    .grid-cell.booked {
      border: 1px solid #333;
    }
    .grid-cell.booked.room-1 {
      background: #d4a5a5;
      border-color: #b89090;
    }
    .grid-cell.booked.room-2 {
      background: #b299d4;
      border-color: #9680c0;
    }
    .grid-cell.booked.room-4 {
      background: #a5d4a5;
      border-color: #90b890;
    }
    .grid-cell.booked.room-6 {
      background: #c8a882;
      border-color: #b5946e;
    }
    .grid-cell.booked.room-7 {
      background: #e6d45a;
      border-color: #d4c347;
    }
    .grid-cell.booked.online {
      background: #7dd87d;
      border-color: #6bc46b;
    }
    .booking-info {
      font-weight: bold;
      color: #1976d2;
      font-size: 0.8em;
    }
    .client-name {
      color: #666;
      font-size: 0.7em;
    }
    .date-selector {
      font-weight: bold;
    }
    .week-navigation {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .counsellor-info {
      background: #e8f4f8;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2 id="pageTitle">Cherry Tree Centre - Room Booking Calendar</h2>
    <div class="view-selector">
      <button class="view-btn active" onclick="switchView('day')">Day View</button>
      <button class="view-btn" onclick="switchView('week')">Week View</button>
    </div>
    <div class="counsellor-filter">
      <label>Counsellor:</label>
      <select id="counsellorSelect" onchange="filterByCounsellor()">
        <option value="">All Counsellors</option>
      </select>
    </div>
  </div>

  <div class="main-container">
    <div class="form-container">
      <div id="counsellorInfo" class="counsellor-info hidden">
        <h3 id="counsellorName"></h3>
        <p id="counsellorSummary"></p>
      </div>
      
      <!-- Custom booking change form -->
      <div style="background: #f9f9f9; padding: 20px; border-radius: 8px;">
        <h3>Modify Booking</h3>
        <p style="margin-bottom: 15px; font-size: 14px; color: #666;">Click on a booking in the calendar to modify it.</p>
        
        <form id="bookingChangeForm">
          <div style="margin-bottom: 15px;">
            <div style="font-size: 14px; line-height: 1.4;">
              <div style="margin-bottom: 8px;"><strong>Current Room:</strong> <span id="currentRoomDisplay"></span></div>
              <div style="margin-bottom: 8px;"><strong>Current Date:</strong> <span id="currentDateDisplay"></span></div>
              <div style="margin-bottom: 8px;"><strong>Current Time:</strong> <span id="currentTimeDisplay"></span></div>
            </div>
          </div>
          
          <!-- Hidden fields for form submission -->
          <input type="hidden" id="bookingCodeInput">
          <input type="hidden" id="currentRoomInput">
          <input type="hidden" id="currentDateInput">
          <input type="hidden" id="currentTimeInput">
          <input type="hidden" id="counsellorNameInput">
          
          <hr style="margin: 20px 0; border: 1px solid #ddd;">
          <h4 style="margin-bottom: 15px; color: #007bff;">Requested Changes:</h4>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">New Room (if changing):</label>
            <select id="newRoomInput" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
              <option value="">No change</option>
              <option value="Room 1">Room 1</option>
              <option value="Room 2">Room 2</option>
              <option value="Room 4">Room 4</option>
              <option value="Room 6">Room 6</option>
              <option value="Room 7">Room 7</option>
              <option value="Online">Online</option>
            </select>
          </div>
          
          <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">New Date (if changing):</label>
            <input type="date" id="newDateInput" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">New Time (if changing):</label>
            <select id="newTimeInput" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
              <option value="">No change</option>
              <option value="08:00">08:00</option>
              <option value="09:00">09:00</option>
              <option value="10:00">10:00</option>
              <option value="11:00">11:00</option>
              <option value="12:00">12:00</option>
              <option value="13:00">13:00</option>
              <option value="14:00">14:00</option>
              <option value="15:00">15:00</option>
              <option value="16:00">16:00</option>
              <option value="17:00">17:00</option>
              <option value="18:00">18:00</option>
              <option value="19:00">19:00</option>
              <option value="20:00">20:00</option>
            </select>
          </div>
          
          <button type="submit" style="background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; font-weight: bold;">
            Submit Change Request
          </button>
        </form>
        
        <div id="submitStatus" style="margin-top: 15px; padding: 12px; border-radius: 4px; display: none;"></div>
      </div>
    </div>
    
    <div class="calendar-container">
      <div class="controls">
        <div id="dayControls">
          <label class="date-selector">Date:</label>
          <input type="date" id="dateSelector" />
        </div>
        
        <div id="weekControls" class="hidden">
          <div class="week-navigation">
            <button onclick="changeWeek(-1)">← Previous Week</button>
            <span id="weekDisplay"></span>
            <button onclick="changeWeek(1)">Next Week →</button>
          </div>
        </div>
        
        <button onclick="refreshData()">Refresh Data</button>
        <span id="dataStatus" style="margin-left: 15px; font-size: 0.9em; color: #666;"></span>
      </div>
      
      <div class="calendar-grid day-view" id="calendarGrid">
        <!-- Dynamic grid will be inserted here -->
      </div>
    </div>
  </div>

  <script>
    // Your Google Apps Script configuration
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxa2_UjEA8M4II8nOKg8HkPiKeV6CYTJ6YBCnMkaT0jlgj5ALXunqmoRWTWn71OFQLwPA/exec';
    
    const rooms = ["Room 1", "Room 2", "Room 4", "Room 6", "Room 7", "Online"];
    const businessHours = Array.from({length: 13}, (_, i) => `${String(i + 8).padStart(2, '0')}:00`);
    const weekDays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    
    let bookingData = [];
    let currentView = 'day';
    let currentDate = new Date().toISOString().split('T')[0];
    let currentWeekStart = new Date();
    let selectedCounsellor = '';

    // Set today's date as default
    document.getElementById('dateSelector').value = currentDate;
    
    // Set current week
    currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay()); // Start of week (Sunday)

    // Parse URL parameters
    function parseURLParams() {
      const params = new URLSearchParams(window.location.search);
      const view = params.get('view');
      const counsellor = params.get('counsellor');
      const date = params.get('date');
      
      if (view && (view === 'day' || view === 'week')) {
        currentView = view;
      }
      
      // Only set counsellor for week view
      if (counsellor && currentView === 'week') {
        selectedCounsellor = decodeURIComponent(counsellor);
      }
      
      if (date) {
        currentDate = date;
        document.getElementById('dateSelector').value = currentDate;
        currentWeekStart = new Date(date);
        currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay());
      }
    }

    function prefillForm(bookingCode, room, date, time) {
      // Update the visible display spans
      const roomDisplay = document.getElementById('currentRoomDisplay');
      const dateDisplay = document.getElementById('currentDateDisplay');
      const timeDisplay = document.getElementById('currentTimeDisplay');
      
      // Update the hidden form inputs for submission
      const bookingCodeInput = document.getElementById('bookingCodeInput');
      const currentRoomInput = document.getElementById('currentRoomInput');
      const currentDateInput = document.getElementById('currentDateInput');
      const currentTimeInput = document.getElementById('currentTimeInput');
      const counsellorNameInput = document.getElementById('counsellorNameInput');
      
      if (!roomDisplay || !dateDisplay || !timeDisplay) {
        console.warn('Display elements not found, cannot pre-fill form');
        return;
      }
      
      // Update visible displays
      roomDisplay.textContent = room || '';
      dateDisplay.textContent = date || '';
      timeDisplay.textContent = time || '';
      
      // Update hidden inputs for form submission
      if (bookingCodeInput) bookingCodeInput.value = bookingCode || '';
      if (currentRoomInput) currentRoomInput.value = room || '';
      if (currentDateInput) currentDateInput.value = date || '';
      if (currentTimeInput) currentTimeInput.value = time || '';
      
      // Always auto-fill counsellor name (hidden field for submission)
      if (selectedCounsellor && counsellorNameInput) {
        counsellorNameInput.value = selectedCounsellor;
      } else if (counsellorNameInput) {
        counsellorNameInput.value = 'Please select counsellor from dropdown above';
      }
      
      // Clear any previous new values
      const newRoomInput = document.getElementById('newRoomInput');
      const newDateInput = document.getElementById('newDateInput');
      const newTimeInput = document.getElementById('newTimeInput');
      
      if (newRoomInput) newRoomInput.value = '';
      if (newDateInput) newDateInput.value = '';
      if (newTimeInput) newTimeInput.value = '';
      
      console.log('Pre-filled form with:');
      console.log('  Booking Code:', bookingCode);
      console.log('  Room:', room);
      console.log('  Date:', date);
      console.log('  Time:', time);
      console.log('  Counsellor:', selectedCounsellor || 'Not set');
    }

    async function submitBookingChange(changeData) {
      const statusDiv = document.getElementById('submitStatus');
      
      try {
        statusDiv.style.display = 'block';
        statusDiv.style.background = '#fff3cd';
        statusDiv.style.color = '#856404';
        statusDiv.style.border = '1px solid #ffeaa7';
        statusDiv.textContent = 'Submitting change request...';
        
        // Use FormData for better Google Apps Script compatibility
        const formData = new FormData();
        formData.append('action', 'submitBookingChange');
        formData.append('timestamp', new Date().toISOString());
        formData.append('originalBookingCode', changeData.originalBookingCode);
        formData.append('originalRoom', changeData.originalRoom);
        formData.append('originalDate', changeData.originalDate);
        formData.append('originalTime', changeData.originalTime);
        formData.append('newRoom', changeData.newRoom || '');
        formData.append('newDate', changeData.newDate || '');
        formData.append('newTime', changeData.newTime || '');
        formData.append('counsellorName', changeData.counsellorName);
        
        console.log('Submitting form data:');
        console.log('  Original Booking Code:', changeData.originalBookingCode);
        console.log('  Counsellor Name:', changeData.counsellorName);
        console.log('  New Room:', changeData.newRoom);
        console.log('  New Date:', changeData.newDate);
        console.log('  New Time:', changeData.newTime);
        
        // Submit to the dedicated change requests Google Sheet
        const CHANGE_REQUESTS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwVIQAryAHaD9HfEqAvaxXDo-nd1BSN664E4Kyg1tVWgmOsTfG6VS7JYgHohqN7HQiz/exec';
        
        const response = await fetch(CHANGE_REQUESTS_SCRIPT_URL, {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          const result = await response.text(); // Use text() instead of json()
          console.log('Response:', result);
          
          if (result.includes('SUCCESS')) {
            statusDiv.style.background = '#d4edda';
            statusDiv.style.color = '#155724';
            statusDiv.style.border = '1px solid #c3e6cb';
            statusDiv.textContent = 'Change request submitted successfully! Check the "Booking Change Requests" tab in your spreadsheet.';
          } else {
            throw new Error('Submission failed: ' + result);
          }
          
          // Clear the new values (keep current values visible)
          document.getElementById('newRoomInput').value = '';
          document.getElementById('newDateInput').value = '';
          document.getElementById('newTimeInput').value = '';
          document.getElementById('notesInput').value = '';
          
          // Hide status after 7 seconds
          setTimeout(() => {
            statusDiv.style.display = 'none';
          }, 7000);
          
        } else {
          throw new Error(`Server responded with ${response.status}`);
        }
        
      } catch (error) {
        console.error('Submission error:', error);
        statusDiv.style.background = '#f8d7da';
        statusDiv.style.color = '#721c24';
        statusDiv.style.border = '1px solid #f5c6cb';
        statusDiv.textContent = 'Error submitting request. Please try again or contact support.';
      }
    }

    function updateURL() {
      const params = new URLSearchParams();
      params.set('view', currentView);
      
      // Only include counsellor parameter for week view
      if (currentView === 'week' && selectedCounsellor) {
        params.set('counsellor', encodeURIComponent(selectedCounsellor));
      }
      
      if (currentView === 'day') {
        params.set('date', document.getElementById('dateSelector').value);
      } else {
        params.set('date', formatDate(currentWeekStart));
      }
      
      const newURL = window.location.pathname + '?' + params.toString();
      window.history.replaceState({}, '', newURL);
    }

    function switchView(view) {
      currentView = view;
      
      console.log('Switching to view:', view);
      
      // Update view buttons
      const buttons = document.querySelectorAll('.view-btn');
      if (buttons.length > 0) {
        buttons.forEach(btn => btn.classList.remove('active'));
        // Find the button that was clicked
        const clickedButton = event ? event.target : document.querySelector(`[onclick="switchView('${view}')"]`);
        if (clickedButton) {
          clickedButton.classList.add('active');
        }
      }
      
      // Show/hide controls based on view
      const dayControls = document.getElementById('dayControls');
      const weekControls = document.getElementById('weekControls');
      const counsellorFilter = document.getElementById('counsellorFilter');
      
      if (dayControls) dayControls.classList.toggle('hidden', view !== 'day');
      if (weekControls) weekControls.classList.toggle('hidden', view !== 'week');
      if (counsellorFilter) counsellorFilter.classList.toggle('hidden', view !== 'week');
      
      // Reset counsellor filter for day view
      if (view === 'day') {
        selectedCounsellor = '';
        const counsellorSelect = document.getElementById('counsellorSelect');
        if (counsellorSelect) counsellorSelect.value = '';
      }
      
      // Update grid class
      const grid = document.getElementById('calendarGrid');
      if (grid) {
        grid.className = `calendar-grid ${view}-view`;
      }
      
      // Update page title and info
      updateCounsellorInfo();
      
      // Recreate grid and populate
      createCalendarGrid();
      populateCalendar();
      updateURL();
    }

    function filterByCounsellor() {
      selectedCounsellor = document.getElementById('counsellorSelect').value;
      updateCounsellorInfo();
      populateCalendar();
      updateURL();
    }

    function updateCounsellorInfo() {
      const infoDiv = document.getElementById('counsellorInfo');
      const nameDiv = document.getElementById('counsellorName');
      const summaryDiv = document.getElementById('counsellorSummary');
      
      if (currentView === 'day') {
        // Day view - show all bookings, no counsellor filter
        infoDiv.classList.add('hidden');
        document.getElementById('pageTitle').textContent = 'Cherry Tree Centre - Admin Day View';
      } else if (selectedCounsellor) {
        // Week view with counsellor selected
        const counsellorBookings = bookingData.filter(booking => 
          booking.client.toLowerCase().includes(selectedCounsellor.toLowerCase())
        );
        
        nameDiv.textContent = selectedCounsellor;
        summaryDiv.textContent = `${counsellorBookings.length} bookings found`;
        infoDiv.classList.remove('hidden');
        
        document.getElementById('pageTitle').textContent = `My Bookings - ${selectedCounsellor}`;
      } else {
        // Week view with no counsellor selected
        infoDiv.classList.add('hidden');
        document.getElementById('pageTitle').textContent = 'Select Your Name to View Your Bookings';
      }
    }

    function populateCounsellorDropdown() {
      const select = document.getElementById('counsellorSelect');
      const counsellors = new Set();
      
      bookingData.forEach(booking => {
        if (booking.client && booking.client.trim()) {
          counsellors.add(booking.client.trim());
        }
      });
      
      // Clear existing options
      select.innerHTML = '<option value="">Select Counsellor</option>';
      
      // Add counsellor options
      Array.from(counsellors).sort().forEach(counsellor => {
        const option = document.createElement('option');
        option.value = counsellor;
        option.textContent = counsellor;
        if (counsellor === selectedCounsellor) {
          option.selected = true;
        }
        select.appendChild(option);
      });
    }

    function getWeekStartDate(date) {
      const result = new Date(date);
      const day = result.getDay();
      const diff = result.getDate() - day + (day === 0 ? -6 : 1); // Monday as start
      result.setDate(diff);
      result.setHours(0, 0, 0, 0);
      return result;
    }

    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    function changeWeek(direction) {
      currentWeekStart.setDate(currentWeekStart.getDate() + (direction * 7));
      updateWeekDisplay();
      populateCalendar();
      updateURL();
    }

    function updateWeekDisplay() {
      const weekEnd = new Date(currentWeekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);
      
      const startStr = currentWeekStart.toLocaleDateString();
      const endStr = weekEnd.toLocaleDateString();
      
      document.getElementById('weekDisplay').textContent = `${startStr} - ${endStr}`;
    }

    function createCalendarGrid() {
      console.log('Creating calendar grid for view:', currentView);
      const grid = document.getElementById("calendarGrid");
      
      if (!grid) {
        console.error('Could not find calendarGrid element!');
        return;
      }
      
      grid.innerHTML = '';
      
      if (currentView === 'day') {
        createDayGrid(grid);
      } else {
        createWeekGrid(grid);
      }
      
      console.log('Calendar grid created successfully!');
    }

    function createDayGrid(grid) {
      console.log('Creating day grid...');
      
      // Empty top-left cell
      const emptyCell = document.createElement("div");
      emptyCell.className = "grid-header";
      emptyCell.textContent = "Time";
      grid.appendChild(emptyCell);
      
      // Header row with room names
      rooms.forEach(room => {
        const header = document.createElement("div");
        header.className = "grid-header";
        header.textContent = room;
        grid.appendChild(header);
      });
      
      console.log('Day grid headers added, adding time rows...');
      
      // Time rows
      businessHours.forEach(time => {
        // Time label
        const timeCell = document.createElement("div");
        timeCell.className = "time-header";
        timeCell.textContent = time;
        grid.appendChild(timeCell);
        
        // Room cells for this time
        rooms.forEach((room) => {
          const cell = document.createElement("div");
          cell.className = "grid-cell";
          
          let roomId;
          if (room === "Room 1") roomId = "1";
          else if (room === "Room 2") roomId = "2";
          else if (room === "Room 4") roomId = "4";
          else if (room === "Room 6") roomId = "6";
          else if (room === "Room 7") roomId = "7";
          else if (room === "Online") roomId = "online";
          
          cell.id = `cell-${roomId}-${time}`;
          grid.appendChild(cell);
        });
      });
      
      console.log('Day grid completed with', grid.children.length, 'cells');
    }

    function createWeekGrid(grid) {
      console.log('Creating week grid...');
      
      // Empty top-left cell
      const emptyCell = document.createElement("div");
      emptyCell.className = "grid-header";
      emptyCell.textContent = "Time";
      grid.appendChild(emptyCell);
      
      // Header row with days
      for (let i = 0; i < 7; i++) {
        const date = new Date(currentWeekStart);
        date.setDate(date.getDate() + i);
        
        const header = document.createElement("div");
        header.className = "grid-header";
        header.textContent = `${weekDays[i]} ${date.getDate()}/${date.getMonth() + 1}`;
        grid.appendChild(header);
      }
      
      console.log('Week grid headers added, adding time rows...');
      
      // Time rows
      businessHours.forEach(time => {
        // Time label
        const timeCell = document.createElement("div");
        timeCell.className = "time-header";
        timeCell.textContent = time;
        grid.appendChild(timeCell);
        
        // Day cells for this time
        for (let day = 0; day < 7; day++) {
          const cell = document.createElement("div");
          cell.className = "grid-cell";
          cell.id = `week-cell-${day}-${time}`;
          grid.appendChild(cell);
        }
      });
      
      updateWeekDisplay();
      console.log('Week grid completed with', grid.children.length, 'cells');
    }

    function populateCalendar() {
      console.log('Populating calendar - View:', currentView, 'Selected counsellor:', selectedCounsellor, 'Booking data length:', bookingData.length);
      
      // Clear all cells first
      const cells = document.querySelectorAll('.grid-cell');
      console.log('Found', cells.length, 'grid cells to populate');
      
      cells.forEach(cell => {
        cell.innerHTML = '';
        cell.classList.remove('booked', 'room-1', 'room-2', 'room-4', 'room-6', 'room-7', 'online');
      });

      let filteredBookings = bookingData;
      
      // Filter by counsellor only in week view
      if (currentView === 'week' && selectedCounsellor) {
        filteredBookings = bookingData.filter(booking => 
          booking.client && booking.client.toLowerCase().includes(selectedCounsellor.toLowerCase())
        );
        console.log('Filtered bookings for', selectedCounsellor, ':', filteredBookings.length);
      } else if (currentView === 'day') {
        console.log('Day view - showing all bookings:', bookingData.length);
      }
      
      if (currentView === 'day') {
        populateDayView(filteredBookings);
      } else {
        populateWeekView(filteredBookings);
      }
      
      console.log('Calendar population complete');
    }

    function populateDayView(filteredBookings) {
      const selectedDate = document.getElementById('dateSelector').value;
      
      // Filter bookings for selected date (no counsellor filter in day view)
      const dayBookings = bookingData.filter(booking => booking.date === selectedDate);
      
      dayBookings.forEach(booking => {
        const startHour = parseInt(booking.start.split(':')[0]);
        const endHour = parseInt(booking.end.split(':')[0]);
        
        const {roomNumber, roomClass} = getRoomMapping(booking);
        if (!roomNumber) return;
        
        // Fill cells for the duration of the booking
        for (let hour = startHour; hour < endHour; hour++) {
          if (hour >= 8 && hour <= 20) {
            const timeString = `${String(hour).padStart(2, '0')}:00`;
            const cellId = `cell-${roomNumber}-${timeString}`;
            const cell = document.getElementById(cellId);
            
            if (cell) {
              cell.classList.add('booked', roomClass);
              // Day view: Show client name as main heading
              cell.innerHTML = `
                <div class="booking-info">${booking.client || ''}</div>
                <div class="client-name">${booking.finalBookingId || booking.code || ''}</div>
              `;
            }
          }
        }
      });
    }

    function populateWeekView(filteredBookings) {
      // If no counsellor selected in week view, don't show any bookings
      if (!selectedCounsellor) {
        return;
      }
      
      for (let day = 0; day < 7; day++) {
        const date = new Date(currentWeekStart);
        date.setDate(date.getDate() + day);
        const dateStr = formatDate(date);
        
        const dayBookings = filteredBookings.filter(booking => booking.date === dateStr);
        
        dayBookings.forEach(booking => {
          const startHour = parseInt(booking.start.split(':')[0]);
          const endHour = parseInt(booking.end.split(':')[0]);
          
          for (let hour = startHour; hour < endHour; hour++) {
            if (hour >= 8 && hour <= 20) {
              const timeString = `${String(hour).padStart(2, '0')}:00`;
              const cellId = `week-cell-${day}-${timeString}`;
              const cell = document.getElementById(cellId);
              
              if (cell) {
                const {roomClass} = getRoomMapping(booking);
                const roomDisplayName = getRoomDisplayName(booking);
                
                cell.classList.add('booked', roomClass);
                // Week view: Show room name as main heading
                cell.innerHTML = `
                  <div class="booking-info">${roomDisplayName}</div>
                  <div class="client-name">${booking.finalBookingId || booking.code || ''}</div>
                `;
                
                // Add click handler to populate form with booking data
                cell.addEventListener('click', function() {
                  console.log('=== BOOKING CLICK DEBUG ===');
                  console.log('Full booking object:', booking);
                  console.log('booking.finalBookingId:', booking.finalBookingId);
                  console.log('booking.code:', booking.code);
                  console.log('typeof finalBookingId:', typeof booking.finalBookingId);
                  console.log('typeof code:', typeof booking.code);
                  
                  // Use Column H (finalBookingId) only - no fallback needed
                  const bookingCode = booking.finalBookingId;
                  const room = roomDisplayName;
                  const date = dateStr;
                  const time = booking.start;
                  
                  console.log('Final values being sent to form:');
                  console.log('  bookingCode (finalBookingId):', bookingCode);
                  console.log('  room:', room);
                  console.log('  date:', date);
                  console.log('  time:', time);
                  console.log('=== END CLICK DEBUG ===');
                  
                  prefillForm(bookingCode, room, date, time);
                  
                  // Scroll to form for better UX
                  const formContainer = document.querySelector('.form-container');
                  if (formContainer) {
                    formContainer.scrollIntoView({ behavior: 'smooth' });
                  }
                });
              }
            }
          }
        });
      }
    }

    function getRoomDisplayName(booking) {
      if (booking.room === 'Room_1' || booking.room === '1') return 'Room 1';
      if (booking.room === 'Room_2' || booking.room === '2') return 'Room 2';
      if (booking.room === 'Room_4' || booking.room === '4') return 'Room 4';
      if (booking.room === 'Room_6' || booking.room === '6') return 'Room 6';
      if (booking.room === 'Room_7' || booking.room === '7') return 'Room 7';
      if (booking.location && booking.location.toLowerCase().includes('online')) return 'Online';
      return booking.room || 'Unknown';
    }

    function getRoomMapping(booking) {
      let roomNumber, roomClass;
      
      if (booking.room === 'Room_1' || booking.room === '1') {
        roomNumber = '1'; roomClass = 'room-1';
      } else if (booking.room === 'Room_2' || booking.room === '2') {
        roomNumber = '2'; roomClass = 'room-2';
      } else if (booking.room === 'Room_4' || booking.room === '4') {
        roomNumber = '4'; roomClass = 'room-4';
      } else if (booking.room === 'Room_6' || booking.room === '6') {
        roomNumber = '6'; roomClass = 'room-6';
      } else if (booking.room === 'Room_7' || booking.room === '7') {
        roomNumber = '7'; roomClass = 'room-7';
      } else if (booking.location && booking.location.toLowerCase().includes('online')) {
        roomNumber = 'online'; roomClass = 'online';
      }
      
      return {roomNumber, roomClass};
    }

    async function loadBookingData() {
      const statusElement = document.getElementById('dataStatus');
      
      try {
        if (statusElement) statusElement.textContent = 'Loading booking data...';
        
        // Simple fetch without problematic headers for Google Apps Script
        const response = await fetch(SCRIPT_URL);
        
        if (!response.ok) {
          throw new Error(`Failed to fetch data: ${response.statusText}`);
        }
        
        const jsonData = await response.json();
        
        // Debug: Log the first few bookings to see the data structure
        console.log('=== BOOKING DATA DEBUG ===');
        console.log('Total bookings loaded:', jsonData.length);
        if (jsonData.length > 0) {
          console.log('Sample booking (first one):');
          console.log('Full booking object:', jsonData[0]);
          console.log('Available fields:', Object.keys(jsonData[0]));
          console.log('finalBookingId field:', jsonData[0].finalBookingId);
          console.log('code field:', jsonData[0].code);
          
          // Check a few more bookings
          for (let i = 0; i < Math.min(5, jsonData.length); i++) {
            console.log(`Booking ${i + 1}:`, {
              finalBookingId: jsonData[i].finalBookingId,
              code: jsonData[i].code,
              client: jsonData[i].client,
              room: jsonData[i].room
            });
          }
        }
        console.log('=== END DEBUG ===');
        
        // Cache the data in browser memory with timestamp
        const cachedData = {
          data: jsonData,
          timestamp: Date.now(),
          expiry: Date.now() + (2 * 60 * 1000) // Cache for 2 minutes
        };
        
        // Store in sessionStorage for faster subsequent loads
        try {
          sessionStorage.setItem('bookingDataCache', JSON.stringify(cachedData));
        } catch (e) {
          console.warn('Could not cache data in sessionStorage:', e);
        }
        
        bookingData = jsonData;
        populateCounsellorDropdown();
        updateCounsellorInfo();
        
        if (statusElement) {
          statusElement.textContent = `Loaded ${jsonData.length} bookings`;
          statusElement.style.color = '#28a745';
          
          setTimeout(() => {
            statusElement.textContent = '';
          }, 3000);
        }
        
        return Promise.resolve();
        
      } catch (error) {
        console.error('Error loading booking data:', error);
        if (statusElement) {
          statusElement.textContent = 'Error loading data';
          statusElement.style.color = '#dc3545';
        }
        
        bookingData = [];
        return Promise.resolve();
      }
    }

    // Progressive loading: Load current week first, then background load other data
    async function loadBookingDataProgressive() {
      const statusElement = document.getElementById('dataStatus');
      
      try {
        if (statusElement) statusElement.textContent = 'Loading current week...';
        
        // For now, just load all data since your Apps Script doesn't support date ranges yet
        // We can add the date range feature to your Apps Script later
        const response = await fetch(SCRIPT_URL);
        
        if (!response.ok) {
          throw new Error(`Failed to fetch data: ${response.statusText}`);
        }
        
        const allData = await response.json();
        
        // Filter current week data client-side for now
        const currentWeekStart = getWeekStartDate(new Date(currentDate + 'T00:00:00'));
        const currentWeekEnd = new Date(currentWeekStart);
        currentWeekEnd.setDate(currentWeekStart.getDate() + 6);
        
        const currentWeekData = allData.filter(booking => {
          const bookingDate = new Date(booking.date + 'T00:00:00');
          return bookingDate >= currentWeekStart && bookingDate <= currentWeekEnd;
        });
        
        // Immediately populate with current week data
        bookingData = currentWeekData;
        populateCounsellorDropdown();
        updateCounsellorInfo();
        populateCalendar();
        
        if (statusElement) {
          statusElement.textContent = `Loaded current week (${currentWeekData.length} bookings)`;
          statusElement.style.color = '#28a745';
        }
        
        // Background loading: Update with all data after a short delay
        setTimeout(() => {
          try {
            // Cache the complete data
            const cachedData = {
              data: allData,
              timestamp: Date.now(),
              expiry: Date.now() + (2 * 60 * 1000)
            };
            
            try {
              sessionStorage.setItem('bookingDataCache', JSON.stringify(cachedData));
            } catch (e) {
              console.warn('Could not cache data:', e);
            }
            
            // Update with complete data
            bookingData = allData;
            populateCounsellorDropdown();
            updateCounsellorInfo();
            
            if (statusElement) {
              statusElement.textContent = `Complete data loaded (${allData.length} bookings)`;
              setTimeout(() => {
                statusElement.textContent = '';
              }, 3000);
            }
          } catch (error) {
            console.warn('Background processing failed:', error);
          }
        }, 100);
        
        return Promise.resolve();
        
      } catch (error) {
        console.error('Error loading data:', error);
        // Fall back to regular loading
        return loadBookingData();
      }
    }

    // Enhanced cache function with progressive loading fallback
    async function loadBookingDataWithCache() {
      const statusElement = document.getElementById('dataStatus');
      
      // Try to load from cache first
      try {
        const cached = sessionStorage.getItem('bookingDataCache');
        if (cached) {
          const cachedData = JSON.parse(cached);
          if (cachedData.timestamp && Date.now() < cachedData.expiry) {
            console.log('Loading data from cache');
            if (statusElement) {
              statusElement.textContent = 'Loading from cache...';
              statusElement.style.color = '#28a745';
            }
            
            bookingData = cachedData.data;
            populateCounsellorDropdown();
            updateCounsellorInfo();
            
            if (statusElement) {
              statusElement.textContent = `Loaded ${cachedData.data.length} bookings (cached)`;
              setTimeout(() => {
                statusElement.textContent = '';
              }, 2000);
            }
            
            return Promise.resolve();
          }
        }
      } catch (e) {
        console.warn('Cache read error:', e);
      }
      
      // If no valid cache, use progressive loading
      return loadBookingDataProgressive();
    }

    function refreshData() {
      console.log('Manual refresh triggered');
      // Clear cache on manual refresh
      try {
        sessionStorage.removeItem('bookingDataCache');
      } catch (e) {
        console.warn('Could not clear cache:', e);
      }
      
      loadBookingData().then(() => {
        console.log('Refresh complete, repopulating calendar');
        populateCalendar();
      });
    }

    // Date selector handler
    document.getElementById('dateSelector').addEventListener('change', function() {
      currentDate = this.value;
      populateCalendar();
      updateURL();
    });

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing...');
      
      // Set up booking change form handler
      const changeForm = document.getElementById('bookingChangeForm');
      if (changeForm) {
        changeForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const changeData = {
            // Current booking info
            originalBookingCode: document.getElementById('bookingCodeInput').value,
            originalRoom: document.getElementById('currentRoomInput').value,
            originalDate: document.getElementById('currentDateInput').value,
            originalTime: document.getElementById('currentTimeInput').value,
            
            // Requested changes
            newRoom: document.getElementById('newRoomInput').value,
            newDate: document.getElementById('newDateInput').value,
            newTime: document.getElementById('newTimeInput').value,
            counsellorName: document.getElementById('counsellorNameInput').value
          };
          
          // Validate that at least one change is requested
          if (!changeData.newRoom && !changeData.newDate && !changeData.newTime) {
            alert('Please specify what changes you would like to make.');
            return;
          }
          
          // Auto-filled counsellor name, but validate it exists
          if (!changeData.counsellorName || changeData.counsellorName === 'Please select counsellor from dropdown above') {
            alert('Please select a counsellor from the dropdown above first.');
            return;
          }
          
          submitBookingChange(changeData);
        });
      }
      
      // Small delay to ensure all elements are rendered
      setTimeout(() => {
        // Parse URL parameters first
        parseURLParams();
        
        // Set initial view state with error checking
        updateViewButtons();
        updateControlsVisibility();
        
        // Set grid class and create grid
        const grid = document.getElementById('calendarGrid');
        if (grid) {
          grid.className = `calendar-grid ${currentView}-view`;
          createCalendarGrid();
        } else {
          console.error('Calendar grid element not found!');
        }
        
        // Load data and populate calendar
        initializeData();
        
        // Auto-refresh data every 5 minutes (but use cache if available)
        setInterval(() => {
          loadBookingDataWithCache().then(() => {
            populateCalendar();
          });
        }, 5 * 60 * 1000);
      }, 100); // 100ms delay to ensure DOM is fully ready
    });

    function updateViewButtons() {
      const buttons = document.querySelectorAll('.view-btn');
      if (buttons.length === 0) {
        console.warn('No view buttons found');
        return;
      }
      
      buttons.forEach(btn => btn.classList.remove('active'));
      
      let activeButton;
      if (currentView === 'day') {
        activeButton = document.querySelector(`[onclick="switchView('day')"]`);
      } else {
        activeButton = document.querySelector(`[onclick="switchView('week')"]`);
      }
      
      if (activeButton) {
        activeButton.classList.add('active');
      } else {
        console.warn(`No button found for view: ${currentView}`);
      }
    }

    function updateControlsVisibility() {
      const dayControls = document.getElementById('dayControls');
      const weekControls = document.getElementById('weekControls');
      const counsellorFilter = document.getElementById('counsellorFilter');
      
      if (dayControls) dayControls.classList.toggle('hidden', currentView !== 'day');
      if (weekControls) weekControls.classList.toggle('hidden', currentView !== 'week');
      if (counsellorFilter) counsellorFilter.classList.toggle('hidden', currentView !== 'week');
    }

    async function initializeData() {
      try {
        await loadBookingDataWithCache();
        
        // Set up counsellor dropdown if in week view
        if (currentView === 'week' && selectedCounsellor) {
          const select = document.getElementById('counsellorSelect');
          if (select) {
            select.value = selectedCounsellor;
          }
          updateCounsellorInfo();
        }
        
        // Always populate calendar after data loads
        populateCalendar();
        
      } catch (error) {
        console.error('Error during data initialization:', error);
        // Show empty calendar even if data loading fails
        populateCalendar();
      }
    }
  </script>
</body>
</html>
