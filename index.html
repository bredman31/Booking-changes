function generateWeeklyEmails() {
  // Configuration
  const SPREADSHEET_ID = '12zynG08Womn61TO_h-rxy6X-7yL9yOqe0_g_7JFPEZk';
  const BOOKING_TAB = 'Booking Summary';
  const EMAIL_OUTPUT_TAB = 'Booking Summary Emails';
  const THERAPIST_EMAIL_TAB = 'Therapist email address';
  const FORM_URL = 'https://docs.google.com/forms/d/e/1FAIpQLSca60SAUPvDP1dHgYETrd-HYOqIlFnTs6ulM-dtPnIwNG6h9w/viewform';
  const CALENDAR_URL = 'https://bredman66.github.io/Booking-changes/';
  
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  
  // Get current week start (Monday)
  const today = new Date();
  const currentWeekStart = new Date(today);
  currentWeekStart.setDate(today.getDate() - today.getDay() + 1); // Monday
  
  // Get week dates
  const weekDates = [];
  for (let i = 0; i < 7; i++) {
    const date = new Date(currentWeekStart);
    date.setDate(date.getDate() + i);
    weekDates.push(Utilities.formatDate(date, Session.getScriptTimeZone(), 'yyyy-MM-dd'));
  }
  
  console.log('Generating emails for week:', weekDates[0], 'to', weekDates[6]);
  
  // Read booking data
  const bookingSheet = ss.getSheetByName(BOOKING_TAB);
  const bookingData = bookingSheet.getDataRange().getValues();
  const bookingHeaders = bookingData[0];
  const bookings = bookingData.slice(1);
  
  // Parse bookings for current week
  const weeklyBookings = new Map(); // counsellor -> bookings[]
  
  bookings.forEach(row => {
    const room = row[0];
    const startRaw = row[1];
    const endRaw = row[2];
    const code = row[3];
    const client = row[4];
    const location = row[5];
    const bookingId = row[7];
    
    if (!room || !startRaw || !endRaw || !client) return;
    
    // Parse dates
    const start = startRaw instanceof Date ? startRaw : ukToDate(startRaw);
    const end = endRaw instanceof Date ? endRaw : ukToDate(endRaw);
    
    if (!(start instanceof Date) || isNaN(start)) return;
    
    const dateStr = Utilities.formatDate(start, Session.getScriptTimeZone(), 'yyyy-MM-dd');
    
    // Check if booking is in current week
    if (weekDates.includes(dateStr)) {
      const counsellor = String(client).trim();
      
      if (!weeklyBookings.has(counsellor)) {
        weeklyBookings.set(counsellor, []);
      }
      
      weeklyBookings.get(counsellor).push({
        date: dateStr,
        start: Utilities.formatDate(start, Session.getScriptTimeZone(), 'HH:mm'),
        end: Utilities.formatDate(end, Session.getScriptTimeZone(), 'HH:mm'),
        room: String(room),
        client: counsellor,
        location: String(location || ''),
        code: String(code || ''),
        bookingId: String(bookingId || '')
      });
    }
  });
  
  console.log('Found bookings for', weeklyBookings.size, 'counsellors');
  
  // Read therapist email addresses
  const therapistSheet = ss.getSheetByName(THERAPIST_EMAIL_TAB);
  const therapistData = therapistSheet.getDataRange().getValues();
  const therapistEmails = new Map();
  
  // Skip header row and map names to emails
  therapistData.slice(1).forEach(row => {
    const name = String(row[0] || '').trim();
    const email = String(row[1] || '').trim();
    if (name && email) {
      therapistEmails.set(name, email);
    }
  });
  
  console.log('Found email addresses for', therapistEmails.size, 'therapists');
  
  // Create or clear email output sheet
  let emailSheet;
  try {
    emailSheet = ss.getSheetByName(EMAIL_OUTPUT_TAB);
    emailSheet.clear();
  } catch (e) {
    emailSheet = ss.insertSheet(EMAIL_OUTPUT_TAB);
  }
  
  // Set headers
  emailSheet.getRange(1, 1, 1, 3).setValues([['Counsellor Name', 'Email HTML', 'Email Address']]);
  
  // Generate emails for each counsellor
  const emailData = [];
  
  weeklyBookings.forEach((bookings, counsellor) => {
    const emailHTML = generateCounsellorEmail(counsellor, bookings, weekDates);
    const emailAddress = therapistEmails.get(counsellor) || 'EMAIL_NOT_FOUND';
    emailData.push([counsellor, emailHTML, emailAddress]);
  });
  
  // Write email data to sheet
  if (emailData.length > 0) {
    emailSheet.getRange(2, 1, emailData.length, 3).setValues(emailData);
  }
  
  console.log('Generated', emailData.length, 'emails');
  return `Generated ${emailData.length} weekly emails`;
}

function generateCounsellorEmail(counsellor, bookings, weekDates) {
  const weekStart = new Date(weekDates[0]);
  const weekEnd = new Date(weekDates[6]);
  
  const weekStartStr = Utilities.formatDate(weekStart, Session.getScriptTimeZone(), 'EEEE, d MMMM yyyy');
  const weekEndStr = Utilities.formatDate(weekEnd, Session.getScriptTimeZone(), 'EEEE, d MMMM yyyy');
  
  // Sort bookings by date and time
  bookings.sort((a, b) => {
    if (a.date !== b.date) return a.date.localeCompare(b.date);
    return a.start.localeCompare(b.start);
  });
  
  const calendarLink = `https://bredman66.github.io/Booking-changes/?view=week&counsellor=${encodeURIComponent(counsellor)}&date=${weekDates[0]}`;
  
  // Generate booking HTML
  const bookingHTML = bookings.map(booking => {
    const bookingDate = new Date(booking.date);
    const dayName = Utilities.formatDate(bookingDate, Session.getScriptTimeZone(), 'EEEE');
    const dateStr = Utilities.formatDate(bookingDate, Session.getScriptTimeZone(), 'd MMMM yyyy');
    
    // Create booking description (Room, Date, Time - no client name)
    const roomDisplay = getRoomDisplayName(booking.room);
    const bookingDescription = `${roomDisplay}, ${dayName} ${dateStr}, ${booking.start}-${booking.end}`;
    
    // Create link to calendar page with pre-filled form
    const calendarFormLink = `https://bredman66.github.io/Booking-changes/?view=day&date=${booking.date}&booking=${encodeURIComponent(booking.bookingId)}&room=${encodeURIComponent(roomDisplay)}&time=${encodeURIComponent(booking.start)}`;
    
    return `
    <div class="booking">
      <div class="booking-time">${dayName}, ${dateStr} • ${booking.start} - ${booking.end}</div>
      <div class="booking-details">
        Room: ${roomDisplay} • 
        Code: ${booking.bookingId || 'N/A'} • 
        Location: ${booking.location || 'N/A'}
      </div>
      <div class="booking-actions">
        <a href="${calendarFormLink}" class="btn" target="_blank">Change This Booking</a>
      </div>
    </div>`;
  }).join('');
  
  // Generate complete email HTML
  return `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body { 
      font-family: Arial, sans-serif; 
      line-height: 1.6; 
      color: #333; 
      max-width: 600px; 
      margin: 0 auto; 
      padding: 20px;
    }
    .header { 
      background: #f8f9fa; 
      padding: 20px; 
      text-align: center; 
      margin-bottom: 20px; 
      border-radius: 8px;
    }
    .booking { 
      background: #f8f9fa; 
      padding: 15px; 
      margin: 15px 0; 
      border-left: 4px solid #007bff; 
      border-radius: 4px; 
    }
    .booking-time { 
      font-weight: bold; 
      color: #333; 
      font-size: 1.1em; 
      margin-bottom: 5px;
    }
    .booking-details { 
      color: #666; 
      margin: 8px 0; 
      font-size: 0.9em;
    }
    .booking-actions { 
      margin-top: 12px; 
    }
    .btn { 
      background: #007bff; 
      color: white; 
      padding: 10px 20px; 
      text-decoration: none; 
      border-radius: 4px; 
      display: inline-block; 
      font-weight: bold;
    }
    .btn:hover {
      background: #0056b3;
    }
    .footer { 
      margin-top: 30px; 
      padding: 20px; 
      background: #f8f9fa; 
      text-align: center; 
      font-size: 0.9em; 
      color: #666; 
      border-radius: 8px;
    }
    .calendar-link {
      margin: 20px 0;
      text-align: center;
    }
    .calendar-btn {
      background: #28a745;
      color: white;
      padding: 12px 24px;
      text-decoration: none;
      border-radius: 4px;
      display: inline-block;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>Your Weekly Bookings</h2>
    <p><strong>${counsellor}</strong></p>
    <p>Week of ${weekStartStr} - ${weekEndStr}</p>
  </div>
  
  <p>Dear ${counsellor},</p>
  <p>Here are your bookings for the upcoming week. If you need to make any changes, click "Change This Booking" next to the relevant appointment.</p>
  
  ${bookingHTML}
  
  <div class="calendar-link">
    <a href="${calendarLink}" class="calendar-btn">View Your Full Weekly Calendar</a>
  </div>
  
  <div class="footer">
    <p><strong>Need Help?</strong></p>
    <p>Click "Change This Booking" next to any appointment to request changes, or view your <a href="${calendarLink}">full weekly calendar</a>.</p>
    <p><strong>Cherry Tree Centre</strong><br>Room Booking System</p>
  </div>
</body>
</html>`;
}

function getRoomDisplayName(room) {
  if (room === 'Room_1' || room === '1') return 'Room 1';
  if (room === 'Room_2' || room === '2') return 'Room 2';
  if (room === 'Room_4' || room === '4') return 'Room 4';
  if (room === 'Room_6' || room === '6') return 'Room 6';
  if (room === 'Room_7' || room === '7') return 'Room 7';
  return String(room);
}

// Parse UK date format "DD/MM/YYYY HH:MM[:SS]"
function ukToDate(v) {
  if (!v) return null;
  if (typeof v === 'string') {
    const m = v.match(/^(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2})(?::(\d{2}))?$/);
    if (m) {
      const [, dd, mm, yyyy, HH, MM, SS] = m;
      return new Date(Number(yyyy), Number(mm) - 1, Number(dd), Number(HH), Number(MM), Number(SS || 0), 0);
    }
  }
  const d = new Date(v);
  return isNaN(d) ? null : d;
}

// Test function - run this to generate emails for current week
function testGenerateEmails() {
  const result = generateWeeklyEmails();
  console.log(result);
}
